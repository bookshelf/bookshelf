<!DOCTYPE HTML>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="chrome=1" />
  <meta name="viewport" content="width=device-width">
  <link rel="canonical" href="http://bookshelfjs.org" />
  <link rel="icon" href="docs/images/favicon.ico" />
  <title>Bookshelf.js - a Javascript ORM for Node.js for PostgreSQL, MySQL, and SQLite3</title>
  <style>
    body {
      font-size: 14px;
      line-height: 22px;
      font-family: Helvetica Neue, Helvetica, Arial;
      background: #FEFFFC;
    }
    .interface {
      font-family: "Lucida Grande", "Lucida Sans Unicode", Helvetica, Arial, sans-serif !important;
    }
    div#sidebar {
      background: #fff;
      position: fixed;
      z-index: 10;
      top: 0; left: 0; bottom: 0;
      width: 200px;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      padding: 15px 0 30px 30px;
      border-right: 1px solid #bbb;
      box-shadow: 0 0 20px #ccc; -webkit-box-shadow: 0 0 20px #ccc; -moz-box-shadow: 0 0 20px #ccc;
    }
      a.toc_title, a.toc_title:visited {
        display: block;
        color: black;
        font-weight: bold;
        margin-top: 15px;
      }
        a.toc_title:hover {
          text-decoration: underline;
        }
        #sidebar .version {
          font-size: 10px;
          font-weight: normal;
        }
      ul.toc_section {
        font-size: 11px;
        line-height: 14px;
        margin: 5px 0 0 0;
        padding-left: 0px;
        list-style-type: none;
        font-family: Lucida Grande;
      }
        .toc_section li {
          cursor: pointer;
          margin: 0 0 3px 0;
        }
          .toc_section li a {
            text-decoration: none;
            color: black;
          }
            .toc_section li a:hover {
              text-decoration: underline;
            }
    div.container {
      position: relative;
      width: 550px;
      margin: 40px 0 50px 260px;
    }
    img#logo {
      width: 450px;
    }
    div.run {
      position: absolute;
      right: 15px;
      width: 26px; height: 18px;
      background: url('docs/images/arrows.png') no-repeat -26px 0;
    }
      div.run:active {
        background-position: -51px 0;
      }
    p, div.container ul {
      margin: 25px 0;
      width: 550px;
    }
      p.warning {
        font-size: 12px;
        line-height: 18px;
        font-style: italic;
      }
      div.container ul {
        list-style: circle;
        padding-left: 15px;
        font-size: 13px;
        line-height: 18px;
      }
        div.container ul li {
          margin-bottom: 10px;
        }
        div.container ul.small {
          font-size: 12px;
        }
    a, a:visited {
      color: #444;
    }
    a:active, a:hover {
      color: #000;
    }
    a.punch {
      display: inline-block;
      background: #4162a8;
      border-top: 1px solid #38538c;
      border-right: 1px solid #1f2d4d;
      border-bottom: 1px solid #151e33;
      border-left: 1px solid #1f2d4d;
      -webkit-border-radius: 4px;
      -moz-border-radius: 4px;
      -ms-border-radius: 4px;
      -o-border-radius: 4px;
      border-radius: 4px;
      -webkit-box-shadow: inset 0 1px 10px 1px #5c8bee, 0px 1px 0 #1d2c4d, 0 6px 0px #1f3053, 0 8px 4px 1px #111111;
      -moz-box-shadow: inset 0 1px 10px 1px #5c8bee, 0px 1px 0 #1d2c4d, 0 6px 0px #1f3053, 0 8px 4px 1px #111111;
      -ms-box-shadow: inset 0 1px 10px 1px #5c8bee, 0px 1px 0 #1d2c4d, 0 6px 0px #1f3053, 0 8px 4px 1px #111111;
      -o-box-shadow: inset 0 1px 10px 1px #5c8bee, 0px 1px 0 #1d2c4d, 0 6px 0px #1f3053, 0 8px 4px 1px #111111;
      box-shadow: inset 0 1px 10px 1px #5c8bee, 0px 1px 0 #1d2c4d, 0 6px 0px #1f3053, 0 8px 4px 1px #111111;
      color: #fff;
      font: bold 14px "helvetica neue", helvetica, arial, sans-serif;
      line-height: 1;
      margin-bottom: 15px;
      padding: 8px 0 10px 0;
      text-align: center;
      text-shadow: 0px -1px 1px #1e2d4d;
      text-decoration: none;
      width: 225px;
      -webkit-background-clip: padding-box; }
      a.punch:hover {
        -webkit-box-shadow: inset 0 0px 20px 1px #87adff, 0px 1px 0 #1d2c4d, 0 6px 0px #1f3053, 0 8px 4px 1px #111111;
        -moz-box-shadow: inset 0 0px 20px 1px #87adff, 0px 1px 0 #1d2c4d, 0 6px 0px #1f3053, 0 8px 4px 1px #111111;
        -ms-box-shadow: inset 0 0px 20px 1px #87adff, 0px 1px 0 #1d2c4d, 0 6px 0px #1f3053, 0 8px 4px 1px #111111;
        -o-box-shadow: inset 0 0px 20px 1px #87adff, 0px 1px 0 #1d2c4d, 0 6px 0px #1f3053, 0 8px 4px 1px #111111;
        box-shadow: inset 0 0px 20px 1px #87adff, 0px 1px 0 #1d2c4d, 0 6px 0px #1f3053, 0 8px 4px 1px #111111;
        cursor: pointer; }
      a.punch:active {
        -webkit-box-shadow: inset 0 1px 10px 1px #5c8bee, 0 1px 0 #1d2c4d, 0 2px 0 #1f3053, 0 4px 3px 0 #111111;
        -moz-box-shadow: inset 0 1px 10px 1px #5c8bee, 0 1px 0 #1d2c4d, 0 2px 0 #1f3053, 0 4px 3px 0 #111111;
        -ms-box-shadow: inset 0 1px 10px 1px #5c8bee, 0 1px 0 #1d2c4d, 0 2px 0 #1f3053, 0 4px 3px 0 #111111;
        -o-box-shadow: inset 0 1px 10px 1px #5c8bee, 0 1px 0 #1d2c4d, 0 2px 0 #1f3053, 0 4px 3px 0 #111111;
        box-shadow: inset 0 1px 10px 1px #5c8bee, 0 1px 0 #1d2c4d, 0 2px 0 #1f3053, 0 4px 3px 0 #111111;
        margin-top: 5px; margin-bottom: 10px }
    a img {
      border: 0;
    }
    h1, h2, h3, h4, h5, h6 {
      padding-top: 20px;
    }
      h2 {
        font-size: 22px;
      }
    b.header {
      font-size: 18px;
      line-height: 35px;
    }
    span.alias {
      font-size: 14px;
      font-style: italic;
      margin-left: 20px;
    }
    table {
      margin: 15px 0 0; padding: 0;
    }
      tr, td {
        margin: 0; padding: 0;
      }
        td {
          padding: 0px 15px 5px 0;
        }
        table .rule {
          height: 1px;
          background: #ccc;
          margin: 5px 0;
        }
    code, pre, tt {
      font-family: Monaco, Consolas, "Lucida Console", monospace;
      font-size: 12px;
      line-height: 18px;
      font-style: normal;
    }
      tt {
        padding: 0px 3px;
        background: #fff;
        border: 1px solid #ddd;
        zoom: 1;
      }
      code {
        margin-left: 20px;
      }
      pre {
        font-size: 12px;
        padding: 2px 0 2px 15px;
        border-left: 4px solid #bbb; border-top: 0; border-bottom: 0;
        margin: 0px 0 25px;
      }
      img.example_image {
        margin: 0px auto;
      }
        img.example_retina {
          margin: 20px;
          box-shadow: 0 8px 15px rgba(0,0,0,0.4);
        }
    @media only screen and (-webkit-max-device-pixel-ratio: 1) and (max-width: 600px),
           only screen and (max--moz-device-pixel-ratio: 1) and (max-width: 600px) {
      div#sidebar {
        display: none;
      }
      img#logo {
        max-width: 450px;
        width: 100%;
        height: auto;
      }
      div.container {
        width: auto;
        margin-left: 15px;
        margin-right: 15px;
      }
        p, div.container ul {
          width: auto;
        }
    }
    @media only screen and (-webkit-min-device-pixel-ratio: 1.5) and (max-width: 640px),
          only screen and (-o-min-device-pixel-ratio: 3/2) and (max-width: 640px),
          only screen and (min-device-pixel-ratio: 1.5) and (max-width: 640px) {
      img {
        max-width: 100%;
        height: auto;
      }
      div#sidebar {
        -webkit-overflow-scrolling: initial;
        position: relative;
        width: 90%;
        height: 120px;
        left: 0;
        top: -7px;
        padding: 10px 0 10px 30px;
        border: 0;
      }
      img#logo {
        width: auto;
        height: auto;
      }
      div.container {
        margin: 0;
        width: 100%;
      }
      p, div.container ul {
        max-width: 98%;
        overflow-x: scroll;
      }
      table {
        position: relative;
      }
        tr:first-child td {
          padding-bottom: 25px;
        }
        td.text {
          padding: 0;
          position: absolute;
          left: 0;
          top: 48px;
        }
        tr:last-child td.text {
          top: 122px;
        }
      pre {
        overflow: scroll;
      }
    }
  </style>
</head>
<body>

  <div id="sidebar" class="interface">

    <a class="toc_title" href="#">
      Bookshelf.js <span class="version">(0.3.1)</span>
    </a>
    <ul class="toc_section">
      <li>&raquo; <a href="http://github.com/tgriesser/bookshelf">GitHub Repository</a></li>
      <li>&raquo; <a href="docs/bookshelf.html">Annotated Source</a></li>
    </ul>

    <a class="toc_title" href="#introduction">
      Introduction
    </a>

    <a class="toc_title" href="#Initialize">
      Initialize
    </a>
    <ul class="toc_section">
      <li>– <a href="#Init-multi-instance">multi-instance</a></li>
    </ul>

    <a class="toc_title" href="#Model">
      Model
    </a>
    <ul class="toc_section">
      <li>– <a href="#Model-extend">extend</a></li>
      <li>– <a href="#Model-forge">forge</a></li>
      <li>– <a href="#Model-constructor">constructor / initialize</a></li>
      <li>– <a href="#Model-tableName">tableName</a></li>
      <li>– <a href="#Model-idAttribute">idAttribute</a></li>
      <li>– <a href="#Model-id">id</a></li>
      <li>– <a href="#Model-set">set</a></li>
      <li>– <a href="#Model-get">get</a></li>
      <li>– <a href="#Model-fetch">fetch</a></li>
      <li>– <a href="#Model-load">load</a></li>
      <li><b><a href="#Model-relation-types">Relation Types:</a></b></li>
      <li>– <a href="#Model-hasOne">hasOne</a></li>
      <li>– <a href="#Model-hasMany">hasMany</a></li>
      <li>– <a href="#Model-belongsTo">belongsTo</a></li>
      <li>– <a href="#Model-belongsToMany">belongsToMany</a></li>
      <li>- <a href="#Model-through">through</a></li>
      <li>&nbsp;&nbsp;- <a href="#Model-attach">attach</a></li>
      <li>&nbsp;&nbsp;- <a href="#Model-detach">detach</a></li>
      <li>&nbsp;&nbsp;- <a href="#Model-withPivot">withPivot</a></li>
      <li><b><a href="#Model-polymorphic-associations">Polymorphic Associations:</a></b></li>
      <li>&nbsp;&nbsp;– <a href="#Model-morphOne">morphOne</a></li>
      <li>&nbsp;&nbsp;– <a href="#Model-morphMany">morphMany</a></li>
      <li>&nbsp;&nbsp;– <a href="#Model-morphTo">morphTo</a></li>
      <li>– <a href="#Model-relations">relations</a></li>
      <li>– <a href="#Model-related">related</a></li>
      <li>– <a href="#Model-relatedData">relatedData</a></li>
      <li>– <a href="#Model-save">save</a></li>
      <li>– <a href="#Model-destroy">destroy</a></li>
      <li>– <a href="#Model-format">format</a></li>
      <li>– <a href="#Model-parse">parse</a></li>
      <li>– <a href="#Model-toJSON">toJSON</a></li>
      <li>– <a href="#Model-Underscore-Methods"><b>Underscore Methods (6)</b></a></li>
      <li>– <a href="#Model-query">query</a></li>
      <li>– <a href="#Model-resetQuery">resetQuery</a></li>
      <li>– <a href="#Model-hasTimestamps">hasTimestamps</a></li>
      <li>– <a href="#Model-timestamp">timestamp</a></li>
      <li>– <a href="#Model-defaults">defaults</a></li>
      <li>– <a href="#Model-isNew">isNew</a></li>
      <li>– <a href="#Model-hasChanged">hasChanged</a></li>
      <li>– <a href="#Model-previous">previous</a></li>
      <li>– <a href="#Model-previousAttributes">previousAttributes</a></li>
      <li>– <a href="#Model-sync">sync</a></li>
    </ul>

    <a class="toc_title" href="#Collection">
      Collection
    </a>
    <ul class="toc_section">
      <li>– <a href="#Collection-extend">extend</a></li>
      <li>– <a href="#Collection-forge">forge</a></li>
      <li>– <a href="#Collection-model">model</a></li>
      <li>– <a href="#Collection-constructor">constructor / initialize</a></li>
      <li>– <a href="#Collection-models">models</a></li>
      <li>– <a href="#Collection-fetch">fetch</a></li>
      <li>– <a href="#Collection-fetchOne">fetchOne</a></li>
      <li>– <a href="#Collection-load">load</a></li>
      <li>– <a href="#Collection-create">create</a></li>
      <li>– <a href="#Collection-parse">parse</a></li>
      <li>– <a href="#Collection-toJSON">toJSON</a></li>
      <li>– <a href="#Collection-query">query</a></li>
      <li>– <a href="#Collection-resetQuery">resetQuery</a></li>
      <li>– <a href="#Collection-sync">sync</a></li>
      <li>– <a href="#Collection-Backbone-Methods"><b>Backbone Methods (19)</b></a></li>
      <li>– <a href="#Collection-Underscore-Methods"><b>Underscore Methods (28)</b></a></li>
    </ul>

    <a class="toc_title" href="#Sync">
      Sync
    </a>
    <ul class="toc_section">
      <li>– <a href="#Sync-first">first</a></li>
      <li>– <a href="#Sync-select">select</a></li>
      <li>– <a href="#Sync-insert">insert</a></li>
      <li>– <a href="#Sync-update">update</a></li>
      <li>– <a href="#Sync-del">del / delete</a></li>
    </ul>

    <a class="toc_title" href="#Events">
      Events
    </a>
    <ul class="toc_section">
      <li>– <a href="#Events-Backbone-Methods"><b>Backbone Methods (5)</b></a></li>
      <li>– <a href="#Events-triggerThen">triggerThen</a></li>
      <li>- <a href="#Events-catalog"><b>Catalog of Built-in Events</b></a></li>
    </ul>

    <a class="toc_title" href="#Utility">
      Utility
    </a>
    <ul class="toc_section">
      <li>– <a href="#Bookshelf-Backbone">Bookshelf.Backbone</a></li>
      <li>– <a href="#Bookshelf-Knex">Bookshelf.Knex</a></li>
      <li>– <a href="#Bookshelf-Transaction">Bookshelf.Transaction</a></li>
    </ul>

    <a class="toc_title" href="#faq">
      F.A.Q.
    </a>

    <a class="toc_title" href="#changelog">
      Change Log
    </a>

  </div>

  <div class="container">

    <p>
      <img id="logo" src="docs/images/bookshelf.png" alt="Bookshelf.js">
    </p>

    <p>
      <b>Bookshelf</b> is a <a href="http://promises-aplus.github.com/promises-spec/">promise based</a> ORM for Node.js,
      built on <a href="http://knexjs.org">Knex</a> query builder.
      It extends the Model &amp; Collection foundations of Backbone.js, providing <a href="#Bookshelf-Transaction">transaction support</a>,
      eager/nested-eager relation loading, <a href="#Model-polymorphic-associations">polymorphic associations</a>, and support for
      one-to-one, one-to-many, and many-to-many relations.
    </p>

    <p>
      It is designed to work well with <b>PostgreSQL</b>, <b>MySQL</b>, and <b>SQLite3</b>.
    </p>

    <p>
      The project is <a href="http://github.com/tgriesser/bookshelf/">hosted on GitHub</a>,
      and the <a href="docs/bookshelf.html">annotated source code</a> is available,
      as well as a full <a href="https://travis-ci.org/tgriesser/bookshelf">test suite</a>.
    </p>

    <h3>Latest Release: 0.3.1</h3>

    <p>
      Current Develop &mdash;
      <a href="https://travis-ci.org/tgriesser/bookshelf">
        <img src="https://travis-ci.org/tgriesser/bookshelf.png?branch=master" alt="Travis Badge">
      </a>
    </p>

    <p>
      Bookshelf is available for use under the <a href="http://github.com/tgriesser/bookshelf/blob/master/LICENSE">MIT software license</a>.
    </p>

    <p>
      You can report bugs and discuss features on the
      <a href="http://github.com/tgriesser/bookshelf/issues">GitHub issues page</a>,
      add pages to the <a href="https://github.com/tgriesser/bookshelf/wiki">wiki</a>
      or send tweets to <a href="http://twitter.com/tgriesser">@tgriesser</a>.
    </p>

    <p>
      Bookshelf's dependencies are listed in the <tt>package.json</tt> file, but include
      <a target="_blank" href="http://backbonejs.org">Backbone.js</a> <small>(1.0.x)</small>,
      <a target="_blank" href="http://underscorejs.org/">Underscore.js</a> <small>(1.4.x)</small>,
      <a target="_blank" href="https://github.com/cujojs/when">when.js</a> <small>(2.1.x)</small>
      for promise flow control, <a target="_blank" href="http://knexjs.org">Knex.js.</a> as the query
      builder foundation, and <a target="_blank" href="https://github.com/dreamerslab/node.inflection">inflection</a>
      for crafting intelligent defaults for related key and table names.
    </p>

    <p>
      Special thanks to <a target="_blank" href="https://twitter.com/taylorotwell">Taylor Otwell</a> and his work
      on the <a target="_blank" href="http://laravel.com/docs/eloquent">Eloquent ORM</a>, which has heavily
      influenced the library's design.
    </p>

    <h2 id="introduction">Introduction</h2>

    <p>
      Bookshelf aims to provide a simple library for common tasks when querying relational
      databases in javascript, and forming relations between these objects, using ideas from
      DataMapper and Active Record. With a <a href="docs/bookshelf.html">concise, literate codebase</a>,
      Bookshelf is simple to read, understand, and extend. It doesn't force you to use any specific
      validation scheme, and provides flexible and efficient relation/nested-relation loading, and
      first class transaction support.
    </p>

    <p>
      Bookshelf extends the excellent foundation provided by Backbone.js Models and Collections,
      using similar patterns, naming conventions, and philosophies to build a lightweight,
      easy to navigate ORM. If you know how to use Backbone, you probably already know how
      to use Bookshelf.
    </p>

    <h2 id="installation">Installation</h2>

    <p>
      All dependencies are specified in package.json file but include underscore.js, when.js, and knex.js library.
      You'll then need to install either <tt>mysql</tt>, <tt>pg</tt>, or <tt>sqlite3</tt> from npm. It is advisable to install your own copy
      of Knex as well if you wish to build any custom queries outside of the ORM.
    </p>

<pre>
$ npm install knex --save

# Then add one of the following:
$ npm install mysql
$ npm install pg
$ npm install sqlite3
</pre>

    <h2 id="Initialize">Bookshelf.Initialize</h2>

    <p>
      Required before using Bookshelf, the initialize performs the setup of the database,
      passing through to Knex's <a href="http://knexjs.org/#Initialize">Initialize</a>.
    </p>

<pre>
Bookshelf.Initialize({
  client: 'mysql',
  connection: {
    host     : 'localhost',
    user     : 'your_database_user',
    password : 'your_database_password',
    database : 'your_db',
    charset  : 'utf8'
  }
});
</pre>

  <p id="Init-multi-instance">
    It is also possible to use <b>Bookshelf</b> with multiple database connection instances if you'd like,
    by creating named instances with <tt>Bookshelf.Initialize</tt>. To do this, pass the name of the
    connection as the first parameter into <b>Bookshelf</b> and it will return that instance, which may
    also be referenced by name under <tt>Bookshelf.Instances</tt>.
  </p>

<pre>
var SqliteDB = Bookshelf.Initialize('sqlitedb', {
  client: 'sqlite',
  connection: {
    filename : './testdb'
  }
});

var MySql2 = Bookshelf.Initialize('mysql2', {
  client: 'mysql',
  connection: { ... }
});

// Bookshelf.Instances['mysql2'] === MySql2;
// Bookshelf.Instances['sqlitedb'] === SqliteDB;
</pre>

    <h2 id="Model">Bookshelf.Model</h2>

    <p>
      <b>Models</b> are simple objects representing individual database rows, specifying the
      <a href="#Model-tableName">tableName</a> and any <a href="#Model-relation-types">relations</a>
      to other models. They can be <a href="#Model-extend">extended</a> with any domain-specific methods,
      which can handle components such as validations, computed properties, and access control.
    </p>

    <p id="Model-extend">
      <b class="header">extend</b><code>Bookshelf.Model.extend(properties, [classProperties])</code>
      <br />
      To create a <b>Model</b> class of your own, you extend <b>Bookshelf.Model</b>
      and provide instance <b>properties</b>, as well as optional
      <b>classProperties</b> to be attached directly to the constructor function.
    </p>

    <p>
      <b>extend</b> correctly sets up the prototype chain, so subclasses created
      with <b>extend</b> can be further extended and subclassed as far as you like.
    </p>

<pre>
var Customer = Bookshelf.Model.extend({

  initialize: function() { ... },

  account: function() { ... },

  login: function() { ... }

});
</pre>

    <p class="warning">
        Brief aside on <tt>super</tt>: JavaScript does not provide
        a simple way to call super &mdash; the function of the same name defined
        higher on the prototype chain. If you override a core function like
        <tt>set</tt>, or <tt>save</tt>, and you want to invoke the
        parent object's implementation, you'll have to explicitly call it, along these lines:
    </p>

<pre>
var Customer = Bookshelf.Model.extend({
  set: function() {
    ...
    Bookshelf.Model.prototype.set.apply(this, arguments);
    ...
  }
});
</pre>

    <p id="Model-forge">
      <b class="header">forge</b><code>Bookshelf.Model.forge(/* args */)</code>
      <br />
      A simple helper function to instantiate a new <tt>Model</tt> without needing <tt>new</tt>.
    </p>

<pre>
var Customer = Bookshelf.Model.extend({
  tableName: 'customers'
});

Customer.forge({item: 'value'}).save().then(function() {
  // ...
});
</pre>


    <p id="Model-constructor">
      <b class="header">constructor / initialize</b><code>new Model([attributes], [options])</code>
      <br />
      When creating an instance of a model, you can pass in the initial values
      of the <b>attributes</b>, which will be <a href="#Model-set">set</a> on the
      model. If you define an <b>initialize</b> function, it will be invoked when
      the model is created.
    </p>

<pre>
new Book({
  title: "One Thousand and One Nights",
  author: "Scheherazade"
});
</pre>

    <p>
      In rare cases, if you're looking to get fancy,
      you may want to override <b>constructor</b>, which allows
      you to replace the actual constructor function for your model.
    </p>

<pre>
var Books = Bookshelf.Model.extend({

  tableName: 'documents',

  constructor: function() {
    Bookshelf.Model.apply(this, arguments);
    this.on('saving', function(model) {
      model.query('where', 'type', '=', 'book');
    });
  }

});
</pre>

    <p>
      The<tt>tableName</tt> and <tt>hasTimestamps</tt> properties
      will be directly attached if passed in the <b>options</b> during model creation.
    </p>

    <p>
      If <tt>{parse: true}</tt> is passed as an <b>option</b>, the <b>attributes</b>
      will first be converted by <a href="#Model-parse">parse</a> before being
      <a href="#Model-set">set</a> on the model.
    </p>

    <p id="Model-tableName">
      <b class="header">tableName</b><code>model.tableName</code>
      <br />
      A required property for any database usage, The <b>tableName</b> property
      refers to the database table name the model will query against.
    </p>

<pre>
var Television = Bookshelf.Model.extend({
  tableName: 'televisions'
});
</pre>

    <p id="Model-idAttribute">
      <b class="header">idAttribute</b><code>model.idAttribute</code>
      <br />
      A database row's unique identifier (typically an auto-incrementing primary key) is stored under this attribute.
    </p>

    <p id="Model-id">
      <b class="header">id</b><code>model.id</code>
      <br />
      A special property of models, the <b>id</b> is the unique idenfifer associated
      named by the <a href="#Model-idAttribute">idAttribute</a>. If you set the <b>id</b>
      in the attributes hash, it will be copied onto the model as a direct property.
      Models can be retrieved by id from collections, and the id is used in fetching models and
      building model relations.
    </p>

    <p id="Model-set">
      <b class="header">set</b><code>model.set(attributes, [options])</code>
      <br />
      Set a hash of attributes (one or many) on the model. If any of the attributes
      change the model's state, a <tt>"change"</tt> event will be triggered.
      Change events for specific attributes are also triggered, and you can
      bind to those as well, for example: <tt>change:title</tt>, and
      <tt>change:content</tt>. You may also pass individual keys and values.
    </p>

<pre>
customer.set({first_name: "Joe", last_name: "Customer"});

customer.set("telephone", "555-555-1212");
</pre>

    <p id="Model-get">
      <b class="header">get</b><code>model.get(attribute)</code>
      <br />
      Get the current value of an attribute from the model. For example:
      <tt>note.get("title")</tt>
    </p>

    <p id="Model-fetch">
      <b class="header">fetch</b><code>model.fetch([options]).then(function(model) {...</code>
      <br />
      Fetches a model from the database, using any attributes currently set on the model
      to form a <tt>select</tt> query. Returns a promise, which will resolve with the fetched Model,
      or <tt>undefined</tt> if the model isn't fetched. If you wish to trigger an error if the fetched model
      is not found, pass <tt>{require: true}</tt> as one of the options to the fetch call. A <tt>"fetched"</tt>
      event will be fired when a record is successfully retrieved.
    </p>

<pre>
// select * from `books` where `ISBN-13` = '9780440180296'
new Book({'ISBN-13': '9780440180296'})
  .fetch()
  .then(function(model) {
    // outputs 'Slaughterhouse Five'
    console.log(model.get('title'));
  });
</pre>

    <p>
      The <tt>withRelated</tt> parameter may be specified to fetch the resource,
      along with any specified <a href="#Model-relations">relations</a> named on the model.
      A single property, or an array of properties can be specified as a value for the <tt>withRelated</tt>
      property. The results of these relation queries will be loaded into a <tt>relations</tt> property on
      the model, may be retreived with the <a href="#Model-related">related</a> method, and will
      be serialized as properties on a <a href="#Model-toJSON">toJSON</a> call unless
      <tt>{shallow: true}</tt> is passed.
    </p>

<pre>
var Book = Bookshelf.Model.extend({
  tableName: 'books',
  editions: function() {
    return this.hasMany(Edition);
  },
  genre: function() {
    return this.belongsTo(Genre);
  }
})

new Book({'ISBN-13': '9780440180296'}).fetch({
  withRelated: ['genre', 'editions']
}).then(function(book) {
  console.log(book.related('genre').toJSON());
  console.log(book.related('editions').toJSON());
  console.log(book.toJSON());
});
</pre>

    <p id="Model-load">
      <b class="header">load</b><code>model.load(relations, [options]).then(function(model) {...</code>
      <br />
      The <b>load</b> method takes an array of <b>relations</b> to eager load attributes onto a Model,
      in a similar way that the <tt>withRelated</tt> property works on fetch. Dot separated attributes
      may be used to specify deep eager loading.
    </p>

<pre>
new Posts().fetch().then(function(collection) {
  collection.at(0)
  .load(['author', 'content', 'comments.tags'])
  .then(function(model) {
    JSON.stringify(model);
  });
});

{
  title: 'post title',
  author: {...},
  content: {...},
  comments: [
    {tags: [...]}, {tags: [...]}
  ]
}
</pre>

    <h3 id="Model-relation-types">Relation Types:</h3>

    <p>
      There are four types of relationships that may be defined between Models and
      Collections: <a href="#Model-hasOne">hasOne</a>, <a href="#Model-hasMany">hasMany</a>,
      <a href="#Model-belongsTo">belongsTo</a>, <a href="#Model-belongsToMany">belongsToMany</a>.
      The relations are specified by created named methods on the model, which return the
      appropriate relation type.
    </p>

<pre>
var Summary = Bookshelf.Model.extend({tableName: 'summaries'});

var Author = Bookshelf.Model.extend({tableName: 'authors'});

var Owner  = Bookshelf.Model.extend({tableName: 'owners'});

var Book = Bookshelf.Model.extend({
  summary: function() {
    return this.hasOne(Summary);
  },
  owner: function() {
    return this.belongsTo(Author);
  },
  pages: function() {
    return this.hasMany(Pages);
  },
  author: function() {
    return this.belongsToMany(Author);
  }
});

new Book({id: 1}).summary().fetch().then(function(summary) {
  console.log(summary.toJSON());
});
</pre>

    <p>
      Relations may also be loaded eagerly, by specifying a <tt>withRelated</tt> option
      during the fetch call.
    </p>

<pre>
new Book({id: 2}).fetch({
  withRelated: ['summary', 'owner', 'pages', 'author']
}).then(function(book) {
  console.log(book.toJSON());
  var owner = book.related('owner');
  if (owner) {
    console.log(owner.toJSON());
  }
});
</pre>

    <p>
      You may also want to eagerly load related models on a model or collection after it has already been fetched.
      For this, you may use the <a href="#Model-load">load</a> method to specify which relations should be eagerly
      loaded on the model or collection.
    </p>

<pre>
var accounts = new Accounts();
accounts.fetch()
  .then(function(collection) {
    return collection.at(0).load('account_info');
  })
  .then(function(model) {
    res.json({
      accounts: accounts.toJSON({shallow: true}),
      current_account: model
    });
  });
</pre>


    <p>
      Nested eager loads may be performed, by separating the nested relations with <tt>'.'</tt>.
    </p>

<pre>
new Story({id: 2}).fetch({
  withRelated: ['comments.tags', 'comments.author', 'author']
}).then(function(model) {
  JSON.stringify(model);
});

// performs 5 queries in total, outputting:
{
  id: 2,
  title: '',
  author: {...},
  comments: [
    {tags: [{...}, {...}], author: {...}},
    {tags: [...], author: {...}},
    {tags: [...], author: {...}}
  ]
}
</pre>

    <p>
      An object may be passed as a relation, where the first argument is the key and the second a function
      which constraints the relation, called with the context of the current related model and accepting the
      Knex query builder object as the first argument.
    </p>

<pre>
new Story({id: 2}).fetch({
  withRelated: ['comments.tags', 'comments.author', {
    'author': function(qb) {
      qb.where('status', 'active')
    }
  }]
}).then(...
</pre>

    <p id="Model-hasOne">
      <b class="header">hasOne</b><code>model.hasOne(Model, [foreignKey])</code>
      <br />
      A one-to-one relation is a very basic relation, where the model has exactly
      one of another <b>Model</b>, referenced by a <b>foreignKey</b> in the target <b>Model</b>.
      By default, the foreign key is assumed to be the singular form of the current model,
      followed by <tt>_id</tt>.
    </p>

<pre>
var Record = Bookshelf.Model.extend({
  tableName: 'health_records'
});

var Patient = Bookshelf.Model.extend({
  record: function() {
    return this.hasOne(Record);
  }
});

// select * from `health_records` where `patient_id` = 1;
new Patient({id: 1}).record().fetch().then(function(model) {
  ...
});
</pre>

    <p>
      If the foreign key is different than the one assumed by the query builder, you may specify
      it in the second argument of the query.
    </p>

    <p id="Model-hasMany">
      <b class="header">hasMany</b><code>model.hasMany(Target, [foreignKey])</code>
      <br />
      Typically the most common relationship type, a <tt>hasMany</tt> is when the <b>model</b>
      has a "one-to-many" relationship with the <b>Target</b> model or collection. The
      <b>model</b> is referenced by a <b>foreignKey</b>, which defaults to the
      <a href="#Model-tableName">tableName</a> of the current model.
    </p>

    <p id="Model-belongsTo">
      <b class="header">belongsTo</b><code>model.belongsTo(Model, [otherKey])</code>
      <br />
      The <tt>belongsTo</tt> defines an inverse one-to-one relation, where the current model is a member
      of another <b>Model</b>, referenced by the <b>otherKey</b> in the target <b>Model</b>.
      By default, the other key is assumed to be the singular form of the target <b>Model</b> with a
      <tt>_id</tt> suffix.
    </p>

<pre>
var Book = Bookshelf.Model.extend({
  author: function() {
    return this.belongsTo(Author);
  }
});

// select * from `author` where
new Book({id: 1}).author().fetch().then(function() {

});
</pre>


    <p id="Model-belongsToMany">
      <b class="header">belongsToMany</b><code>model.belongsToMany(Target, [table], [fKey], [otherKey])</code>
      <br />
      The <tt>belongsToMany</tt> method defines a many-to-many relation, where the current <b>Model</b>
      is joined to one ore more of a <b>Target</b> model through another <b>table</b>. The default name for
      the joining table is the two table names, joined by an underscore, ordered alphabetically. For example, a
      <tt>users</tt> table and an <tt>accounts</tt> table would have a joining table of <tt>accounts_users</tt>.

<pre>
var Account = Bookshelf.Model.extend({
  tableName: 'accounts'
});

var User = Bookshelf.Model.extend({

  tableName: 'users',

  allAccounts: function () {
    return this.belongsToMany(Account);
  },

  adminAccounts: function() {
    return this.belongsToMany(Account).query('where', 'access', '=', 'admin');
  },

  viewAccounts: function() {
    return this.belongsToMany(Account).query('where', 'access', '=', 'readonly');
  }

});
</pre>

    <p>
      The default key names in the joining table are the singular version of the table name, followed by <tt>_id</tt>.
      So in the above case, the columns in the joining table would be <tt>user_id</tt>, <tt>account_id</tt>, and
      <tt>access</tt>, which is used as an example of how dynamic relations can be formed using different contexts. To
      customize the keys or <tt>tableName</tt> used in the join table, you may specify them like so:
    </p>

<pre>
this.belongsToMany(Account, 'users_accounts', 'userid', 'accountid');
</pre>

    <p>
      If you wish to create a <tt>belongsToMany</tt> association where the joining table has a primary key, and
      more information about the model, you may create a belongsToMany <a href="#Model-through">through</a> relation:
    </p>

<pre>
var Doctor = Bookshelf.Model.extend({

  patients: function() {
    return this.belongsToMany(Patient).through(Appointment);
  }

});

var Appointment = Bookshelf.Model.extend({

  patient: function() {
    return this.belongsTo(Patient);
  },

  doctor: function() {
    return this.belongsTo(Doctor);
  }

});

var Patient = Bookshelf.Model.extend({

  doctors: function() {
    return this.belongsToMany(Doctor).through(Appointment);
  }

});
</pre>

    <p id="Model-through">
      <b class="header">through</b><code>.through(JoinModel, [throughFk], [otherKey])</code>
      <br />
      The <tt>through</tt> method helps to create dynamic relations between models &amp; collections, where a
      <a href="#Model-hasOne">hasOne</a>, <a href="#Model-hasMany">hasMany</a>, <a href="#Model-belongsTo">belongsTo</a>,
      or <a href="#Model-belongsToMany">belongsToMany</a> relation may run <tt>through</tt> a <b>JoinModel</b>.
    </p>

    <p>
      A good example of where this would be useful is if a book <tt>hasMany</tt> paragraphs <tt>through</tt>
      chapters. Consider the following examples:
    </p>

<pre>
var Book = Bookshelf.Model.extend({

  // Find all paragraphs associated with this book, by
  // passing through the "Chapter" model.
  paragraphs: function() {
    return this.hasMany(Paragraph).through(Chapter);
  },

  chapters: function() {
    return this.hasMany(Chapter);
  }

});

var Chapter = Bookshelf.Model.extend({

  paragraphs: function() {
    return this.hasMany(Paragraph);
  }

});

var Paragraph = Bookshelf.Model.extend({

  chapter: function() {
    return this.belongsTo(Chapter);
  },

  // A reverse relation, where we can get the book from the chapter.
  book: function() {
    return this.belongsTo(Book).through(Chapter);
  }

});
</pre>

    <p>
      The "through" table creates a pivot model, which it assigns to <tt>model.pivot</tt> after it is created.
      On <tt>toJSON</tt>, the pivot model is flattened to values prefixed with <tt>_pivot_</tt>.
    </p>

    <p id="Model-attach">
      <b class="header">attach</b><code>relation.attach(ids, [options])</code>
      <br />
      Attaches one or more <b>ids</b> from a foreign table to the current table, in a
      <a href="#Model-belongsToMany">belongsToMany</a> relationship.
      Creates &amp; saves a new model and attaches the model with the related model.
    </p>

<pre>
new Site({id: 1}).admins().attach([1, 2]);
</pre>

  <p>
    The attach function may also take one or more models to attach to the current
    model:
  </p>

<pre>
var admin1 = new Admin({username: 'user1', password: 'test'});
var admin2 = new Admin({username: 'user2', password: 'test'});

When.all([admin1.save(), admin2.save()])
  .then(function() {
    return When.all([
      new Site({id: 1}).admins().attach([admin1, admin2]),
      new Site({id: 2}).admins().attach(admin2)
    ]);
  })
</pre>

    <p id="Model-detach">
      <b class="header">detach</b><code>relation.detach(ids, [options])</code>
      <br />
      Detach one or more related object from their pivot tables. If a model or id is passed,
      it attempts to remove the pivot table based on that foreign key. If no parameters
      are specified, we assume we will detach all related associations.
    </p>

    <p id="Model-withPivot">
      <b class="header">withPivot</b><code>relation.withPivot(columns)</code>
      <br />
      The <tt>withPivot</tt> method is used exclusively on <a href="#Model-belongsToMany">belongsToMany</a>
      relations, and allows for additional fields to be pulled from the joining table.
    </p>

<pre>
var Tag = Bookshelf.Model.extend({
  comments: function() {
    return this.belongsToMany(Comment).withPivot(['created_at', 'order']);
  }
});
</pre>

  <p>
    By default, the pivot attributes are defined with the <tt>_pivot_</tt> prefix. If you would
    like to specify how they are named on the related models, pass an object with the key/value pairs
    to <tt>withPivot</tt>.
  </p>

<pre>
var Tag = Bookshelf.Model.extend({
  comments: function() {
    return this.belongsToMany(Comment).withPivot({
      created_at: 'comment_created_at',
      order: 'order'
    });
  }
});

new Tag({id: 1}).comments().fetch().then(function(model) {
  JSON.stringify(model);
  // {id: 1, name: 'tag name', comments: [
  //   {id: 1, comment_created_at: ..., order: ...},
  //   {id: 2, comment_created_at: ..., order: ...}
  // ];
});
</pre>

    <h3 id="Model-polymorphic-associations">Polymorphic Associations:</h3>

    <p>
      With <b>polymorphic associations</b>, a model can belong to more than one other model,
      on a single association. For example, you might have a photo model that belongs
      to either a <tt>Site</tt> model or a <tt>Post</tt> model. Here’s how this could be declared:
    </p>

<pre>
var Site = Bookshelf.Model.extend({
  tableName: 'sites',
  photo: function() {
    return this.morphOne(Photo, 'imageable');
  }
});

var Post = Bookshelf.Model.extend({
  tableName: 'posts',
  photos: function() {
    return this.morphMany(Photo, 'imageable');
  }
});

var Photo = Bookshelf.Model.extend({
  tableName: 'photos',
  imageable: function() {
    return this.morphTo('imageable', Site, Author);
  }
});
</pre>

    <p id="Model-morphOne">
      <b class="header">morphOne</b><code>model.morphOne(Target, name, [morphValue])</code>
      <br />
      The <b>morphOne</b> is used to signify a polymorphic relation with another <b>Target</b> model,
      where the <b>name</b> of the model is used to determine which database table keys are used.
      The naming convention requires the <tt>name</tt> prefix an <tt>_id</tt> and <tt>_type</tt> field in
      the database. So for the case above the table names would be <tt>imageable_type</tt> and <tt>imageable_id</tt>.
      The <b>morphValue</b> may be optionally set to store/retrieve a different value in the <tt>_type</tt>
      column than the <a href="#Model-tableName">tableName</a>.
    </p>

<pre>
var Site = Bookshelf.Model.extend({
  tableName: 'sites',
  photo: function() {
    return this.morphOne(Photo, 'imageable');
  }
});
</pre>

    <p id="Model-morphMany">
      <b class="header">morphMany</b><code>model.morphMany(Target, name, [morphValue])</code>
      <br />
      The <b>morphMany</b> property is essentially the same as a morphOne, but creating a collection rather than a
      model (similar to a hasOne vs. hasMany relation). The <b>morphValue</b> may be optionally set to store/retrieve
      a different value in the <tt>_type</tt> column than the <a href="#Model-tableName">tableName</a>.
    </p>

<pre>
var Post = Bookshelf.Model.extend({
  tableName: 'posts',
  photos: function() {
    return this.morphMany(Photo, 'imageable');
  }
});
</pre>

    <p id="Model-morphTo">
      <b class="header">morphTo</b><code>model.morphTo(name, targets*)</code>
      <br />
      The <b>morphTo</b> relation is used to specify the inverse of the "morphOne" or "morphMany" relations,
      where the <b>targets</b> (constructors) must be passed to signify which models are the potential opposite end of the
      polymorphic relation.
    </p>

<pre>
var Photo = Bookshelf.Model.extend({
  tableName: 'photos',
  imageable: function() {
    return this.morphTo('imageable', Site, Author);
  }
});
</pre>

    <p class="warning">
      Note: a morphTo may not have a nested eager relation underneath it. From the example above, you could
      not do something like:
    </p>

<pre>
new Photos().fetch({
  withRelated: ['imageable.otherRelation']
});
</pre>

    <p class="warning">The <tt>otherRelation</tt> in this case would be ignored.</p>

    <p id="Model-relations">
      <b class="header">relations</b><code>model.relations</code>
      <br />
      The <b>relations</b> property is the internal hash containing each of the relations
      (models or collections) loaded on the model with <a href="#Model-load">load</a> or with
      the <tt>withRelated</tt> property during <a href="#Model-fetch">fetch</a>. You can access
      the relation using the <a href="#Model-related">related</a> method on the model.
    </p>

    <p id="Model-related">
      <b class="header">related</b><code>model.related([relation])</code>
      <br />
      The <b>related</b> method returns a specified <b>relation</b> loaded on the <a href="#Model-relations">relations</a>
      hash on the model, or calls the associated relation method and adds it to the <tt>relations</tt> hash if one exists
      and has not yet been loaded. Returns undefined if the specified relation does not exist.
    </p>

<pre>
new Photo({id: 1}).fetch({
  withRelated: ['accounts']
}).then(function(photo) {
  if (photo) {
    var account = photo.related('account');
    if (account.id) {
      return account.related('trips').fetch();
    }
  }
});
</pre>

    <p id="Model-relatedData">
      <b class="header">relatedData</b><code>model.relatedData</code>
      <br />
      The <b>relatedData</b> is an internal "Relation" object of information about the current model's relation,
      including the <tt>type</tt>, <tt>foreignKey</tt>, <tt>fkValue</tt>, and other data depending
      on the relation type. Mainly for use internally, but possibly helpful for custom behavior.
    </p>

    <p id="Model-save">
      <b class="header">save</b><code>model.save([params], [options]).then(function(model) {...</code>
      <br />
      The Model's <b>save</b> method is used to perform an <tt>insert</tt> or <tt>update</tt>
      query with the model, dependent on whether the model <a href="#Model-isNew">isNew</a>.
      If the model <tt>isNew</tt>, any <a href="#Model-defaults">defaults</a> will be added to
      the object being saved. If you wish to use <tt>update</tt> rather than <tt>insert</tt> or
      vice versa, the <tt>{method: ...}</tt> option may be specified to explicitly state which
      <a href="#Sync">sync</a> method to use in the save call. If the method is <tt>update</tt>,
      a <tt>{defaults: true}</tt> option may be specified to also merge with the default values.
    </p>

<pre>
new Post({name: 'New Article'}).save().then(function(model) {
  // ...
});
</pre>

    <p>
      If you only wish to update with the <b>params</b> passed to the <tt>save</tt>, you may pass
      a <tt>{patch: true}</tt> flag to the database:
    </p>

<pre>
// update authors set "bio" = 'Short user bio' where "id" = 1
new Author({id: 1, first_name: 'User'})
  .save({bio: 'Short user bio'}, {patch: true})
  .then(function(model) {
    // ...
  });
</pre>

    <p>
      Several events fired on the model when saving: a <tt>"creating"</tt>, or <tt>"updating"</tt>
      event if the model is being inserted or updated, and a <tt>"saving"</tt> event in either case. To prevent
      saving the model (with validation, etc.), throwing an error inside one of these event listeners will stop
      saving the model and reject the promise. A <tt>"created"</tt>, or <tt>"updated"</tt> event is fired after the
      model is saved, as well as a <tt>"saved"</tt> event either way.
    </p>

    <p id="Model-destroy">
      <b class="header">destroy</b><code>model.destroy</code>
      <br />
      The Model's <b>destroy</b> method performs a <tt>delete</tt> on the model, using the model's
      <a href="#Model-idAttribute">idAttribute</a> to constrain the query.
      A <tt>"destroying"</tt> event is triggered on the model before being destroyed. To prevent
      destroying the model (with validation, etc.), throwing an error inside one of these event listeners will stop
      destroying the model and reject the promise. A <tt>"destroyed"</tt> event is fired after the model's removal
      is completed.
    </p>

    <p id="Model-attributes">
      <b class="header">attributes</b><code>model.attributes</code>
      <br />
      The <b>attributes</b> property is the internal hash containing the database row.
    </p>

    <p>
      Please use <a href="#Model-set">set</a> to update the <b>attributes</b>
      instead of modifying them directly. If you'd like to retrieve and munge a
      copy of the model's attributes, use <a href="#Model-toJSON">toJSON</a>
      instead.
    </p>

    <p id="Model-defaults">
      <b class="header">defaults</b><code>model.defaults or model.defaults()</code>
      <br />
      The <b>defaults</b> hash (or function) can be used to specify the default
      attributes for your model. Unlike with Backbone's model defaults, Bookshelf defaults
      are applied before an "insert" query, rather than during object creation.
    </p>

<pre>
var Meal = Bookshelf.Model.extend({
  defaults: {
    appetizer:  "caesar salad",
    entree:     "ravioli",
    dessert:    "cheesecake"
  }
});

alert("Dessert will be " + (new Meal).get('dessert'));
</pre>

    <p class="warning">
      Remember that in JavaScript, objects are passed by reference, so if you
      include an object as a default value, it will be shared among all instances.
      Instead, define <b>defaults</b> as a function.
    </p>

    <p id="Model-format">
      <b class="header">format</b><code>model.format(attributes, [options])</code>
      <br />
      The <b>format</b> method is used to modify the current state of the model before
      it is persisted to the database. The <b>attributes</b> passed are a shallow clone
      of the model, and are only used for inserting/updating - the current values of the
      model are left intact.
    </p>

<pre>
// Example of a "format" to convert camelCase to snake_case when saving, using `underscore.string`
model.format = function(attrs) {
  return _.reduce(attrs, function(memo, val, key) {
    memo[_.str.underscored(key)] = val;
    return memo;
  }, {});
};
</pre>

    <p id="Model-parse">
      <b class="header">parse</b><code>model.parse(response, [options])</code>
      <br />
      The <b>parse</b> method is called whenever a model's data is returned in a
      <a href="#Model-fetch">fetch</a> call. The function is passed
      the raw database <tt>response</tt> object, and should return the attributes hash
      to be <a href="#Model-set">set</a> on the model. The default implementation
      is a no-op, simply passing through the JSON response. Override this if
      you need to format the database responses - for example calling <tt>JSON.parse</tt>
      on a text field containing <tt>JSON</tt>, or explicitly typecasting a boolean
      in a <tt>sqlite3</tt> database response.
    </p>

<pre>
// Example of a "parse" to convert snake_case to camelCase, using `underscore.string`
model.parse = function(attrs) {
  return _.reduce(attrs, function(memo, val, key) {
    memo[_.str.camelize(key)] = val;
    return memo;
  }, {});
};
</pre>

    <p id="Model-toJSON">
      <b class="header">toJSON</b><code>model.toJSON([options])</code>
      <br />
      Return a copy of the model's <a href="#Model-attributes">attributes</a> for JSON stringification.
      If the model has any <a href="#Model-relations">relations</a> defined, this will also call
      <tt>toJSON</tt> on each of the related objects, and include them on the object unless <tt>{shallow: true}</tt>
      is passed as an option. For more information on the use of <tt>toJSON</tt>, check out the
      <a href="https://developer.mozilla.org/en/JSON#toJSON()_method">JavaScript API for <b>JSON.stringify</b></a>.
    </p>

<pre>
var artist = new Bookshelf.Model({
  firstName: "Wassily",
  lastName: "Kandinsky"
});

artist.set({birthday: "December 16, 1866"});

console.log(JSON.stringify(artist));
</pre>

    <p id="Model-Underscore-Methods">
      <b class="header">Underscore Methods (6)</b>
      <br />
      Bookshelf proxies to <b>Underscore.js</b> to provide 6 object functions
      on <b>Bookshelf.Model</b>. They aren't all documented here, but
      you can take a look at the Underscore documentation for the full details&hellip;
    </p>

    <ul class="small">
      <li><a href="http://underscorejs.org/#keys">keys</a></li>
      <li><a href="http://underscorejs.org/#values">values</a></li>
      <li><a href="http://underscorejs.org/#pairs">pairs</a></li>
      <li><a href="http://underscorejs.org/#invert">invert</a></li>
      <li><a href="http://underscorejs.org/#pick">pick</a></li>
      <li><a href="http://underscorejs.org/#omit">omit</a></li>
    </ul>

<pre>
user.pick('first_name', 'last_name', 'email');

chapters.keys().join(', ');
</pre>

    <p id="Model-query">
      <b class="header">query</b><code>model.query([method], [*parameters])</code>
      <br />
      The <tt>query</tt> method is used to tap into the underlying <a href="http://knexjs.org">Knex</a>
      query builder instance for the current model. If called with no arguments, it will return the query
      builder directly. Otherwise, it will call the specified <tt>method</tt> on the query builder, applying
      any additional arguments from the <tt>model.query</tt> call. If the <tt>method</tt> argument is a function,
      it will be called with the Knex query builder as the context and the first argument, returning the current
      model.
    </p>

<pre>
model
  .query('where', 'other_id', '=', '5')
  .fetch()
  .then(function(model) {
    ...
  });

model.query(function(qb) {
  qb.where('other_person', 'LIKE', '%Demo').orWhere('other_id', '>', 10);
}).fetch()
  .then(function(model) {...

var qb = model.query();
    qb.where({id: 1}).select().then(function(resp) {...
</pre>

    <p id="Model-resetQuery">
      <b class="header">resetQuery</b><code>model.resetQuery()</code>
      <br />
      Used to reset the internal state of the current query builder instance. This method is
      called internally each time a database action is completed by <tt>Bookshelf.Sync</tt>.
    </p>

    <p id="Model-hasTimestamps">
      <b class="header">hasTimestamps</b><code>model.hasTimestamps</code>
      <br />
      If this value is set, the <a href="#Model-timestamp">timestamp</a> method will
      be called on a <tt>model.save()</tt> to set the <tt>created_at</tt> and <tt>updated_at</tt>
      values on save. If this value is an array, the first value will be used as the model's
      key for the "created at" value and the second for the "updated at" value.
    </p>

<pre>
var PostModel = Bookshelf.Model.extend({
  hasTimestamps: ['createdAt', 'updatedAt']
});
</pre>

    <p id="Model-timestamp">
      <b class="header">timestamp</b><code>model.timestamp(options)</code>
      <br />
      Sets the timestamp attributes on the model, if <tt>hasTimestamps</tt> is set to true.
      The default implementation is to check if the model <a href="#Model-isNew">isNew</a> and
      set the <tt>created_at</tt> and <tt>updated_at</tt> attributes to the current date if it is new,
      and just the <tt>updated_at</tt> attribute if it isn't. You may override this method if you
      wish to use different column names or types for the timestamps.
    </p>

    <p id="Model-clone">
      <b class="header">clone</b><code>model.clone()</code>
      <br />
      Returns a new instance of the model with identical attributes, including any relations
      from the cloned model.
    </p>

    <p id="Model-isNew">
      <b class="header">isNew</b><code>model.isNew()</code>
      <br />
      Checks for the existence of an <a href="#Model-id">id</a> to determine whether the model
      is considered "new".
    </p>

<pre>
var modelA = new Bookshelf.Model();
modelA.isNew(); // true

var modelB = new Bookshelf.Model({id: 1});
modelB.isNew(); // false
</pre>

    <p id="Model-changed">
      <b class="header">changed</b><code>model.changed</code>
      <br />
      The <b>changed</b> property is the internal hash containing all the attributes
      that have changed since the model's last <a href="#Model-fetch">fetch</a>,
      <a href="#Model-save">save</a>, or <a href="#Model-destroy">destroy</a>.
    </p>

    <p id="Model-hasChanged">
      <b class="header">hasChanged</b><code>model.hasChanged([attribute])</code>
      <br />
      Checks whether an attribute has changed since the last <a href="#Model-fetch">fetch</a>,
      <a href="#Model-save">save</a>, or <a href="#Model-destroy">destroy</a>. If an <b>attribute</b>
      is passed, returns <tt>true</tt> if that specific attribute has changed.
    </p>

    <p id="Model-previous">
      <b class="header">previous</b><code>model.previous(attribute)</code>
      <br />
      Returns the this previous value of a changed <b>attribute</b>, or <tt>undefined</tt>
      if one had not been specified previously.
    </p>

    <p id="Model-previousAttributes">
      <b class="header">previousAttributes</b><code>model.previousAttributes()</code>
      <br />
      Return a copy of the model's previous attributes from the model's last <a href="#Model-fetch">fetch</a>,
      <a href="#Model-save">save</a>, or <a href="#Model-destroy">destroy</a>. Useful for getting a
      diff between versions of a model, or getting back to a valid state after an error occurs.
    </p>

    <p id="Model-sync">
      <b class="header">sync</b><code>model.sync(method, model, [options])</code>
      <br />
      Creates and returns a new <a href="#Sync">Bookshelf.Sync</a> instance. Can be overridden for custom behavior.
    </p>

    <h2 id="Collection">Bookshelf.Collection</h2>

    <p>
      Collections are ordered sets of models returned from the database,
      which may be used with a full suite of <a href="#Collection-Underscore-Methods">Underscore.js methods</a>.
    </p>

    <p id="Collection-extend">
      <b class="header">extend</b><code>Bookshelf.Collection.extend(properties, [classProperties])</code>
      <br />
      To create a <b>Collection</b> class of your own, extend <b>Bookshelf.Collection</b>,
      providing instance <b>properties</b>, as well as optional <b>classProperties</b> to be attached
      directly to the collection's constructor function.
    </p>

    <p id="Collection-forge">
      <b class="header">forge</b><code>Bookshelf.Collection.forge(/* args */)</code>
      <br />
      A simple helper function to instantiate a new <tt>Collection</tt> without needing <tt>new</tt>.
    </p>

<pre>
var when = require('when');
var Accounts = Bookshelf.Collection.extend({
  model: Account
});

var accounts = Accounts.forge([
  {name: 'Person1'},
  {name: 'Person2'}
])

when.all(accounts.invoke('save')).then(function() {
  // collection models should now be saved...
});
</pre>

    <p id="Collection-model">
      <b class="header">model</b><code>collection.model</code>
      <br />
      Override this property to specify the model class that the collection
      contains. If defined, you can pass raw attributes objects (and arrays) to
      <a href="#Collection-add">add</a>, <a href="#Collection-create">create</a>,
      and <a href="#Collection-reset">reset</a>, and the attributes will be
      converted into a model of the proper type. Unlike in Backbone.js, the model
      attribute may not be a polymorphic model.
    </p>

<pre>
var Trilogy = Bookshelf.Collection.extend({
  model: Book
});
</pre>

    <p id="Collection-constructor">
      <b class="header">constructor / initialize</b><code>new Collection([models], [options])</code>
      <br />
      When creating a Collection, you may choose to pass in the initial array
      of <b>models</b>.  The collection's <a target="_blank" href="http://backbonejs.org/#Collection-comparator">comparator</a>
      may be included as an option. Passing <tt>false</tt> as the
      comparator option will prevent sorting. If you define an
      <b>initialize</b> function, it will be invoked when the collection is
      created.
    </p>

<pre>
var tabs = new TabSet([tab1, tab2, tab3]);
</pre>

    <p id="Collection-models">
      <b class="header">models</b><code>collection.models</code>
      <br />
      Raw access to the JavaScript array of models inside of the collection. Usually you'll
      want to use <tt>get</tt>, <tt>at</tt>, or the <b>Underscore methods</b>
      to access model objects, but occasionally a direct reference to the array
      is desired.
    </p>

    <p id="Collection-parse">
      <b class="header">parse</b><code>collection.parse(response, [options])</code>
      <br />
      The <b>parse</b> method is called whenever a collection's data is returned in a
      <a href="#Collection-fetch">fetch</a> call. The function is passed
      the raw database <tt>response</tt> array, and should return an array
      to be set on the collection. The default implementation
      is a no-op, simply passing through the JSON response.
    </p>

    <p id="Collection-toJSON">
      <b class="header">toJSON</b><code>collection.toJSON([options])</code>
      <br />
      Return an array containing the <tt>toJSON</tt> for each model in the
      collection. For more information about toJSON, check out
      <a href="https://developer.mozilla.org/en/JSON#toJSON()_method">JavaScript's JSON API</a>.
      You may pass <tt>{shallow: true}</tt> in the options to omit any
      relations loaded on the collection's models.
    </p>


    <p id="Collection-fetch">
      <b class="header">fetch</b><code>collection.fetch([options])</code>
      <br />
      Fetch the default set of models for this collection from the database,
      resetting the collection when they arrive. If you wish to trigger an error if the fetched collection
      is empty, pass <tt>{require: true}</tt> as one of the options to the fetch call. A <tt>"fetched"</tt>
      event will be fired when records are successfully retrieved.
    </p>

    <p id="Collection-fetchOne">
      <b class="header">fetchOne</b><code>collection.fetchOne([options])</code>
      <br />
      Fetch and return a single model from the collection, maintaining any relation data from the collection,
      and any query parameters that have already been passed to the collection. Especially helpful on relations,
      where you would only like to return a single model from the associated collection.
    </p>

<pre>
// select * from authors where site_id = 1 and id = 2 limit 1;
new Site({id:1})
  .authors()
  .query({where: {id: 2}})
  .fetchOne()
  .then(function(model) {
    ... //
  });
</pre>

    <p id="Collection-load">
      <b class="header">load</b><code>collection.load(relations, options).then(function(collection) {...</code>
      <br />
      The <b>load</b> method can be used to eager load attributes onto a Collection, in a similar way
      that the <tt>withRelated</tt> property works on <a href="#Collection-fetch">fetch</a>. Nested eager
      loads can be specified by separating the nested relations with <tt>'.'</tt>.
    </p>

<pre>
new Story({id: 2}).fetch({
  withRelated: ['comments.tags', 'comments.author', 'author']
}).then(function(model) {
  JSON.stringify(model);
});
</pre>

    <p id="Collection-create">
      <b class="header">create</b><code>collection.create(relations, options).then(function(model) {...</code>
      <br />
      Convenience to create a new instance of a model within a collection. Equivalent to instantiating a
      model with a hash of attributes, saving the model to the database, and adding the model to the collection
      after being successfully created. Returns a promise, resolving with the new model.
    </p>

    <p id="Collection-query">
      <b class="header">query</b><code>collection.query([method], [*parameters])</code>
      <br />
      The <tt>query</tt> method is used to tap into the underlying <a href="http://knexjs.org">Knex</a>
      query builder instance for the current collection. If called with no arguments, it will return the query
      builder directly. Otherwise, it will call the specified <tt>method</tt> on the query builder, applying
      any additional arguments from the <tt>collection.query</tt> call. If the <tt>method</tt> argument is a function,
      it will be called with the Knex query builder as the context and the first argument, returning the current
      model.
    </p>

<pre>
var qb = collection.query();
    qb.where({id: 1}).select().then(function(resp) {...

collection.query(function(qb) {
  qb.where('id', '>', 5).andWhere('first_name', '=', 'Test');
}).fetch()
  .then(function(collection) {...

collection
  .query('where', 'other_id', '=', '5')
  .fetch()
  .then(function(collection) {
    ...
  });
</pre>

    <p id="Collection-resetQuery">
      <b class="header">resetQuery</b><code>collection.resetQuery()</code>
      <br />
      Used to reset the internal state of the current query builder instance. This method is
      called internally each time a database action is completed by <tt>Bookshelf.Sync</tt>.
    </p>

    <p id="Collection-sync">
      <b class="header">sync</b><code>collection.sync(collection, [options])</code>
      <br />
      Creates and returns a new <a href="#Sync">Bookshelf.Sync</a> instance. Can be overridden for custom behavior.
    </p>

    <p id="Collection-Backbone-Methods">
      <b class="header">Backbone Methods (19)</b>
      <br />
      Bookshelf also proxies to <b>Backbone.js</b> for any of the core Collection methods
      that don't need modification for the ORM. The Backbone documentation
      applies equally for Bookself, and can be used to read more on these methods.
    </p>

    <ul>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-add">add</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-remove">remove</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-reset">reset</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-set">set</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-get">get</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-at">at</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-push">push</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-pop">pop</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-unshift">unshift</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-shift">shift</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-slice">slice</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-length">length</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-comparator">comparator</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-sort">sort</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-pluck">pluck</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-where">where</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-findWhere">findWhere</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Collection-clone">clone</a></li>
    </ul>

    <p id="Collection-Underscore-Methods">
      <b class="header">Underscore Methods (28)</b>
      <br />
      Just as with <b>Backbone</b>, Bookshelf proxies to <b>Underscore.js</b> to provide 28 iteration functions
      on <b>Bookshelf.Collection</b>. They aren't all documented here, but
      you can take a look at the Underscore documentation for the full details&hellip;
    </p>

    <ul class="small">
      <li><a href="http://underscorejs.org/#each">forEach (each)</a></li>
      <li><a href="http://underscorejs.org/#map">map (collect)</a></li>
      <li><a href="http://underscorejs.org/#reduce">reduce (foldl, inject)</a></li>
      <li><a href="http://underscorejs.org/#reduceRight">reduceRight (foldr)</a></li>
      <li><a href="http://underscorejs.org/#find">find (detect)</a></li>
      <li><a href="http://underscorejs.org/#filter">filter (select)</a></li>
      <li><a href="http://underscorejs.org/#reject">reject</a></li>
      <li><a href="http://underscorejs.org/#all">every (all)</a></li>
      <li><a href="http://underscorejs.org/#any">some (any)</a></li>
      <li><a href="http://underscorejs.org/#include">include (contains)</a></li>
      <li><a href="http://underscorejs.org/#invoke">invoke</a></li>
      <li><a href="http://underscorejs.org/#max">max</a></li>
      <li><a href="http://underscorejs.org/#min">min</a></li>
      <li><a href="http://underscorejs.org/#sortBy">sortBy</a></li>
      <li><a href="http://underscorejs.org/#groupBy">groupBy</a></li>
      <li><a href="http://underscorejs.org/#sortedIndex">sortedIndex</a></li>
      <li><a href="http://underscorejs.org/#shuffle">shuffle</a></li>
      <li><a href="http://underscorejs.org/#toArray">toArray</a></li>
      <li><a href="http://underscorejs.org/#size">size</a></li>
      <li><a href="http://underscorejs.org/#first">first (head, take)</a></li>
      <li><a href="http://underscorejs.org/#initial">initial</a></li>
      <li><a href="http://underscorejs.org/#rest">rest (tail)</a></li>
      <li><a href="http://underscorejs.org/#last">last</a></li>
      <li><a href="http://underscorejs.org/#without">without</a></li>
      <li><a href="http://underscorejs.org/#indexOf">indexOf</a></li>
      <li><a href="http://underscorejs.org/#lastIndexOf">lastIndexOf</a></li>
      <li><a href="http://underscorejs.org/#isEmpty">isEmpty</a></li>
      <li><a href="http://underscorejs.org/#chain">chain</a></li>
    </ul>

  <h2 id="Sync">Bookshelf.Sync</h2>

    <p>
      The <b>Bookshelf.Sync</b> object handles all database communication for models and collections.
      Unlike Backbone's <tt>sync</tt> method, <b>Bookshelf.Sync</b> is a constructor taking two arguments:
      the current <tt>model</tt> (or collection) and any <tt>options</tt> needed for
      the sync method being performed. It comes with five built in
      methods: <a href="#Sync-first">first</a>, <a href="#Sync-select">select</a>,
      <a href="#Sync-insert">insert</a>, <a href="#Sync-update">update</a>, and
      <a href="#Sync-del">del</a> (delete).
    </p>

    <p id="Sync-first">
      <b class="header">first</b><code>sync.first([options]).then(function(model) {...</code>
      <br />
      Used by the model, the <tt>first</tt> method selects the first matching and returns a promise,
      resolving with the model or collection originally passed in the the <a href="#Sync">Bookshelf.Sync</a>.
    </p>

    <p id="Sync-select">
      <b class="header">select</b><code>sync.select([options]).then(function(model) {...</code>
      <br />
      Used by models and collections, the <tt>select</tt> method selects rows from the database based on the
      <a href="#Model-tableName">tableName</a> and <a href="#Model-idAttribute">idAttrribute</a>, along with
      any custom query constraints.
    </p>

    <p id="Sync-insert">
      <b class="header">insert</b><code>sync.insert([options]).then(function(model) {...</code>
      <br />
      Used by models, and relations, the <tt>insert</tt> method inserts a single model, based on the
      <a href="#Model-tableName">tableName</a> and any <a href="#Model-relation-types">relation constraints</a>,
      returning a promise which resolves with the inserted model.
    </p>

    <p id="Sync-update">
      <b class="header">update</b><code>sync.update([options]).then(function(model) {...</code>
      <br />
      Used by models, and relations, the <tt>update</tt> method inserts a single model, based on the
      <a href="#Model-tableName">tableName</a>, <a href="#Model-idAtribute">idAtribute</a> and any custom
      <a href="#Model-query">query</a> or <a href="#Model-relation-types">relation</a> constraints,
      returning a promise which resolves with the inserted model.
    </p>

    <p id="Sync-del">
      <b class="header">del</b><code>sync.del([options]).then(function(model) {...</code>
      <br />
      Used by models, collections, and relations, the <tt>del</tt> method removes one or more models,
      based on the <a href="#Model-tableName">tableName</a>, <a href="#Model-idAtribute">idAtribute</a>
      and any custom <a href="#Model-query">query</a> or <a href="#Model-relation-types">relation</a> constraints,
      returning a promise which resolves with no arguments. If no <a href="#Model-idAtribute">idAtribute</a> or
      custom constraints have been defined, the promise will fail.
    </p>

  <h2 id="Events">Bookshelf.Events</h2>

    <p id="Events-Backbone-Methods">
      <b class="header">Backbone Methods (5)</b><br />
      Bookshelf mixes in the <tt>Events</tt> module from Backbone, and therefore each Model and Collection has access
      to each of the following methods, which can be referenced in the Backbone documentation.
    </p>

    <ul>
      <li><a target="_blank" href="http://backbonejs.org/#Events-on">on</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Events-off">off</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Events-trigger">trigger</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Events-once">once</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Events-listenTo">listenTo</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Events-stopListening">stopListnening</a></li>
      <li><a target="_blank" href="http://backbonejs.org/#Events-listenToOnce">listenToOnce</a></li>
    </ul>

    <p id="Events-triggerThen">
      <b class="header">.triggerThen(name, args*)</b><br />
      A promise version of "trigger", returning a promise which resolves with all return values
      from triggered event handlers. If any of the event handlers throw an <tt>Error</tt> or return
      a rejected promise, the promise will be rejected. Used internally on the "creating", "updating",
      "saving", and "destroying" events, and can be helpful when needing async event handlers (for
      validations, etc).
    </p>

    <p id="Events-catalog">
      <b class="header">Catalog of Events</b>
      <br />
      Here's the complete list of recognized Bookshelf events, with arguments.
      Other events from <tt>Backbone</tt> might be triggered, but aren't officially supported unless they
      are noted in this list. You're also free to trigger your own events on Models and Collections and
      The <tt>Bookshelf</tt> object itself mixes in <tt>Events</tt>, and can be used to emit any
      global events that your application needs.
    </p>

    <p><b>Model:</b></p>

    <ul class="small">
      <li class="ul-header"><b>triggerThen</b> - a thrown Error or returned rejected promise cancels the next action
      <ul class="small">
        <li>   <b>"fetching"</b> (model, columns, options) &mdash; before a model is fetched. </li>
        <li>   <b>"fetched"</b> (model, resp, options) &mdash; after a model is fetched. </li>
        <li>   <b>"creating"</b> (model, attrs, options) &mdash; before a model is inserted. </li>
        <li>   <b>"created"</b> (model, resp, options) &mdash; after a model is created. </li>
        <li>   <b>"updating"</b> (model, attrs, options) &mdash; before a model is updating. </li>
        <li>   <b>"updated"</b> (model, resp, options) &mdash; after a model is updated. </li>
        <li>   <b>"saving"</b> (model, attrs, options) &mdash; called both on creating &amp; updating. </li>
        <li>   <b>"saved"</b> (model, resp, options) &mdash; after a model is created or updated. </li>
        <li>   <b>"destroying"</b> (model, options) &mdash; before a model is destroyed. </li>
        <li>   <b>"destroyed"</b> (model, resp, options) &mdash; after a model is destroyed. </li>
      </ul>
      </li>
      <li class="ul-header"><b>trigger</b> - standard sync event trigger
        <ul class="small">
          <li>   <b>"change"</b> (model, options) &mdash; when a model is changed from the last sync'ed state. </li>
        </ul>
      </li>
    </ul>

    <p><b>Collection:</b></p>
    <ul class="small">
      <li class="ul-header"><b>triggerThen</b> - a thrown Error or returned rejected promise cancels the next action
        <ul class="small">
          <li>  <b>"fetching"</b> (model, columns, options) &mdash; before a collection is fetched. </li>
          <li>  <b>"fetched"</b> (model, resp, options) &mdash; after a collection is fetched. </li>
        </ul>
      </li>
    </ul>

  <h2 id="Utility">Utility</h2>

    <p id="Bookshelf-Backbone">
      <b class="header">Bookshelf.Backbone</b>
      <br />
      A reference to the copy of Backbone used to create the Bookshelf objects can be accessed
      from <tt>Bookshelf.Backbone</tt>. This can be helpful if you want to use Models &amp; Collections
      elsewhere on the server, and ensure they are compatible with the Bookshelf objects.
    </p>

    <p id="Bookshelf-Knex">
      <b class="header">Bookshelf.Knex</b>
      <br />
      A reference to the <tt>Knex.js</tt> instance being used by Bookshelf.
    </p>

    <p id="Bookshelf-Transaction">
      <b class="header">Bookshelf.Transaction</b>
      <br />
      An alias to <a href="http://knexjs.org/#Transaction">Knex.Transaction</a>, the transaction
      object must be passed along in the options of any relevant <tt>Bookshelf.Sync</tt> calls,
      to ensure all queries are on the same connection. The entire transaction block is
      a promise that will resolve when the transaction is committed, or fail if the
      transaction is rolled back.
    </p>

<pre>
var When = require('when');

Bookshelf.Transaction(function(t) {

  new Library({name: 'Old Books'})
    .save(null, {transacting: t})
    .then(function(model) {

      return When.all(_.map([
        {title: 'Canterbury Tales'},
        {title: 'Moby Dick'},
        {title: 'Hamlet'}
      ], function(info) {

        // Some validation could take place here.
        return new Book(info).save('shelf_id', model.id, {transacting: t});
      }));
    })
    .then(function(rows) {
      t.commit([model.get('name'), rows.length]);
    }, t.rollback);

  }).then(function(resp) {

    // ['Old Books', 3]
    console.log(msg);

  }, function() {

    console.log('Error saving the books.');

  });
</pre>

    <h2 id="faq">F.A.Q.</h2>

    <p id="faq-debug">
      <b class="header">My relations don't seem to be loading, what's up?</b><br />
      Make sure you check that the type is correct for the initial parameters passed to the initial model
      being fetched. For example new <tt>Model({id: '1'}).load([relations...])</tt> will not return the same as
      <tt>Model({id: 1}).load([relations...])</tt> - notice that the <tt>id</tt> is a string in one case and a
      number in the other. This can be a common mistake if retrieving the id from a url parameter.<p>
      <p>This is only an issue if you're eager loading data with <tt>load</tt> without first fetching the original model.
      <tt>Model({id: '1'}).fetch({withRelated: [relations...]})</tt> should work just fine.
    </p>

    <p id="faq-debug">
      <b class="header">Can I use standard node.js style callbacks.</b><br />
      Yes - you can call <tt>require('bookshelf/plugins/exec')</tt> after loading Bookshelf, and
      any models/collections created from that point forward will contain both <tt>then</tt> and
      <tt>exec</tt> methods, where the <tt>exec</tt> method takes the standard <tt>(err, result)</tt>
      callback interface.
    </p>

    <p id="faq-debug">
      <b class="header">How do I debug?</b><br />
      If you pass <tt>{debug: true}</tt> as one of the options in your initialize settings, you can see
      all of the query calls being made. Sometimes you need to dive a bit further into
      the various calls and see what all is going on behind the scenes. I'd recommend
      <a href="https://github.com/dannycoates/node-inspector">node-inspector</a>, which allows you to debug
      code with <tt>debugger</tt> statements like you would in the browser.
    </p>

    <p id="faq-tests">
      <b class="header">How do I run the test suite?</b><br />
      The test suite looks for an environment variable called <tt>BOOKSHELF_TEST</tt> for the path to the database
      configuration. If you run the following command:
      <tt>$ export BOOKSHELF_TEST='/path/to/your/bookshelf_config.js'</tt>, replacing with the path to your config file,
      and the config file is valid, the test suite should run with <tt>npm test</tt>.
    </p>

    <p>
      If you're going to add a test, you should set <tt>$ export BOOKSHELF_DEV=1</tt> which will automatically save the
      the outputs data from the tests into the <tt>shared/output.js</tt> file.
    </p>

    <p>
      Also note that you will have to create the appropriate database(s) for the test suite to run. For example, with mysql,
      you'll need to run the command <tt>create database bookshelf_test;</tt> in addition to exporting the correct test settings
      prior to running the test suite.
    </p>

    <p id="faq-nonode">
      <b class="header">Can I use Bookshelf outside of Node.js</b><br />
      While it primarily targets Node.js, all dependencies are browser compatible, and
      it could be adapted to work with other javascript environments supporting a <tt>sqlite3</tt>
      database, by providing a custom <a href="http://knexjs.org/#Adapters">Knex adapter</a>.
    </p>

    <h2 id="changelog">Change Log</h2>

    <p>
      <b class="header">0.3.1</b> &mdash; <small><i>August 29, 2013</i></small><br />
      Fixed regression in <tt>belongsToMany</tt> custom column name order.
    </p>

    <p>
      <b class="header">0.3.0</b> &mdash; <small><i>August 28, 2013</i></small><br />
      Support for a <a href="#Model-through">through</a> clause on various model relations.
      Creating a model from a related collection maintains the appropriate relation data (#35).
      Support for a <tt>{patch: true}</tt> flag on save, to only update specific saved attributes.
      Added a <tt>fetchOne</tt> method, for pulling out a single model from a collection, mostly
      useful for related collection instances. Updated to Knex "0.2.x" syntax for insert / returning,
      Ability to specify a <tt>morphValue</tt> on <a href="#Model-morphOne">morphOne</a> or
      <a href="#Model-morphMany">morphMany</a> relations. Internal refactor of relations for more
      consistent behavior.
    </p>

    <p>
      <b class="header">0.2.8</b> &mdash; <small><i>August 26, 2013</i></small><br />
      Some minor fixes to make the <tt>Sync</tt> methods more consistent in their behavior when called
      directly, (#53).
    </p>

    <p>
      <b class="header">0.2.7</b> &mdash; <small><i>August 21, 2013</i></small><br />
      Timestamp for <tt>created_at</tt> is not set during an "update" query, and the update
      where clause does not include the <tt>idAttribute</tt> if it isn't present (#51).
    </p>

    <p>
      <b class="header">0.2.6</b> &mdash; <small><i>August 21, 2013</i></small><br />
      Fixes bug with query function feature added in <tt>0.2.5</tt>, mentioned in (#51).
    </p>

    <p>
      <b class="header">0.2.5</b> &mdash; <small><i>August 19, 2013</i></small><br />
      The <a href="#Model-query">query</a> method may now accept a function, for even more dynamic
      query building (#45). Fix for relations not allowing "0" as a valid foreign key value (#49).
    </p>

    <p>
      <b class="header">0.2.4</b> &mdash; <small><i>July 30, 2013</i></small><br />
      More consistent query resetting, fixing query issues on post-query event handlers. The <tt>toJSON</tt> is only
      called on a related model if the method exists, allowing for objects or arrays to be manually specified on the
      <tt>relations</tt> hash and serialized properly on the parent's <tt>toJSON</tt>.
    </p>

    <p>
      <b class="header">0.2.3</b> &mdash; <small><i>July 7, 2013</i></small><br />
      Fixing bug where <tt>triggerThen</tt> wasn't actually being used for several of the events as noted in 0.2.1 release.
    </p>

    <p>
      <b class="header">0.2.2</b> &mdash; <small><i>July 2, 2013</i></small><br />
      The Model's <tt>related</tt> method is now a no-op if the model doesn't have the related method. Any
      <tt>withPivot</tt> columns on many-to-many relations are now prefixed with <tt>_pivot</tt> rather than <tt>pivot</tt>
      unless named otherwise, for consistency. The <tt>_reset</tt> is not called until after all triggered
      events so that <tt>hasChanged</tt> can be used on the current model state in the
      "created", "updated", "saved", and "destroyed" events. Eager queries may be specified as an object
      with a function, to constrain the eager queries:
    </p>

<pre>
user.fetch({withRelated: ['accounts', {
  'accounts.settings': function(qb) { qb.where('status', 'enabled'); }
}, 'other_data']}).then(...
</pre>

    <p>
      <b class="header">0.2.1</b> &mdash; <small><i>June 26, 2013</i></small><br />
      Using <tt>triggerThen</tt> instead of <tt>trigger</tt> for "created", "updated", "saved", "destroyed",
      and "fetched" events - if any async operations are needed <i>after</i> the model is created but before
      resolving the original promise.
    </p>

    <p>
      <b class="header">0.2.0</b> &mdash; <small><i>June 24, 2013</i></small><br />
      Resolve Model's <tt>fetch</tt> promise with <tt>null</tt> rather than undefined. An object of <tt>query</tt>.
      constraints (e.g. <tt>{where: {...}, orWhere: {...}}</tt>may be passed to the query method (#30). Fix for empty
      eager relation responses not providing an empty model or collection instance on the
      <tt>model.relations</tt> object.
    </p>

    <p>
      <b class="header">0.1.9</b> &mdash; <small><i>June 19, 2013</i></small><br />
      Resolve Model's <tt>fetch</tt> promise with <tt>undefined</tt> if no model was returned. An array of
      "created at" and "updated at" values may be used for <tt>hasTimestamps</tt>. Format is called on the
      <tt>Model#fetch</tt> method. Added an <tt>exec</tt> plugin to provide a node callback style interface
      for any of the promise methods.
    </p>

    <p>
      <b class="header">0.1.8</b> &mdash; <small><i>June 18, 2013</i></small><br />
      Added support for polymorphic associations, with <tt>morphOne</tt>, <tt>morphMany</tt>, and
      <tt>morphTo</tt> model methods.
    </p>

    <p>
      <b class="header">0.1.7</b> &mdash; <small><i>June 15, 2013</i></small><br />
      Bugfix where <tt>detach</tt> may be used with no parameters to detach all related items (#19).
    </p>

    <p>
      <b class="header">0.1.6</b> &mdash; <small><i>June 15, 2013</i></small><br />
      Fixing bug allowing custom <tt>idAttribute</tt> values to be used in eager loaded many-to-many relations (#18).
    </p>

    <p>
      <b class="header">0.1.5</b> &mdash; <small><i>June 11, 2013</i></small><br />
      Ensuring each of the <tt>_previousAttribute</tt> and <tt>changed</tt> values are properly reset on related
      models after sync actions.
    </p>

    <p>
      <b class="header">0.1.4</b> &mdash; <small><i>June 10, 2013</i></small><br />
      Fixing issue with <tt>idAttribute</tt> not being assigned after database inserts. Removing various aliases
      <a href="#Events">Events</a> methods for clarity.
    </p>

    <p>
      <b class="header">0.1.3</b> &mdash; <small><i>June 10, 2013</i></small><br />
      Added <a href="#Model-hasChanged">hasChanged</a>,
      <a href="#Model-previous">previous</a>, and <a href="#Model-previousAttributes">previousAttributes</a>
      methods, for getting the previous value of the model since the last sync. Using <tt>Object.create(null)</tt> for various
      internal model objects dealing with user values. Calling <a href="#Model-related">related</a> on a model will now create
      an empty related object if one is not present on the <tt>relations</tt> object. Removed the <tt>{patch: true}</tt>
      option on save, instead only applying defaults if the object <tt>isNew</tt>, or if <tt>{defaults: true}</tt> is passed.
      Fix for <tt>model.clone</tt>'s relation responses.
    </p>

    <p>
      <b class="header">0.1.2</b> &mdash; <small><i>May 17, 2013</i></small><br />
      Added <tt>triggerThen</tt> and <tt>emitThen</tt> for promise based events, used internally in the
      "creating", "updating", "saving", and "destroying" events. Docs updates, fixing <tt>{patch: true}</tt>
      on <tt>update</tt> to have intended functionality. A model's <tt>toJSON</tt> is now correctly
      called on any related properties.
    </p>

    <p>
      <b class="header">0.1.1</b> &mdash; <small><i>May 16, 2013</i></small><br />
      Fixed bug with eager loaded <tt>belongsTo</tt> relations (#14).
    </p>

    <p>
      <b class="header">0.1.0</b> &mdash; <small><i>May 13, 2013</i></small><br />
      Initial Bookshelf release.
    </p>

  </div>
  <script src="docs/public/scripts/ga.js" type="text/javascript" charset="utf-8"></script>
</body>
</html>
