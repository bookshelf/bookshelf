<!DOCTYPE html><html lang="en"><head><title>dialects/base/eager</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="dialects/base/eager"><meta name="groc-project-path" content="dialects/base/eager.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">dialects/base/eager.js</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h2 id="eager-base">Eager Base</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">define</span><span class="p">)</span> <span class="p">{</span>

<span class="s2">&quot;use strict&quot;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The EagerBase provides a scaffold for handling with eager relation
pairing, by queueing the appropriate related method calls with
a database specific <code>eagerFetch</code> method, which then may utilize
<code>pushModels</code> for pairing the models depending on the database need.</p></div></div><div class="code"><div class="wrapper"><span class="nx">define</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">_</span>         <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">when</span>      <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;when&#39;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">Backbone</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;backbone&#39;</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">EagerBase</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">parentResponse</span><span class="p">,</span> <span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">parentResponse</span> <span class="o">=</span> <span class="nx">parentResponse</span><span class="p">;</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;pushModels&#39;</span><span class="p">,</span> <span class="s1">&#39;eagerFetch&#39;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">EagerBase</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This helper function is used internally to determine which relations
are necessary for fetching based on the <code>model.load</code> or <code>withRelated</code> option.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">relationName</span><span class="p">,</span> <span class="nx">related</span><span class="p">,</span> <span class="nx">relation</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">target</span>      <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">handled</span>     <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handled</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="kd">var</span> <span class="nx">withRelated</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">prepWithRelated</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">withRelated</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">subRelated</span>  <span class="o">=</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Internal flag to determine whether to set the ctor(s) on the <code>Relation</code> object.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">target</span><span class="p">.</span><span class="nx">_isEager</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Eager load each of the <code>withRelated</code> relation item, splitting on '.'
which indicates a nested eager load.</p></div></div><div class="code"><div class="wrapper">      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">withRelated</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">related</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="nx">relationName</span> <span class="o">=</span> <span class="nx">related</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Add additional eager items to an array, to load at the next level in the query.</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">related</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">relatedObj</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="nx">subRelated</span><span class="p">[</span><span class="nx">relationName</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="nx">subRelated</span><span class="p">[</span><span class="nx">relationName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]);</span>
          <span class="nx">relatedObj</span><span class="p">[</span><span class="nx">related</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">withRelated</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
          <span class="nx">subRelated</span><span class="p">[</span><span class="nx">relationName</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">relatedObj</span><span class="p">);</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Only allow one of a certain nested type per-level.</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">handled</span><span class="p">[</span><span class="nx">relationName</span><span class="p">])</span> <span class="k">continue</span><span class="p">;</span>

        <span class="nx">relation</span> <span class="o">=</span> <span class="nx">target</span><span class="p">[</span><span class="nx">relationName</span><span class="p">]();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">relation</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">relationName</span> <span class="o">+</span> <span class="s1">&#39; is not defined on the model.&#39;</span><span class="p">);</span>

        <span class="nx">handled</span><span class="p">[</span><span class="nx">relationName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">relation</span><span class="p">;</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Delete the internal flag from the model.</p></div></div><div class="code"><div class="wrapper">      <span class="k">delete</span> <span class="nx">target</span><span class="p">.</span><span class="nx">_isEager</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Fetch all eager loaded models, loading them onto
an array of pending deferred objects, which will handle
all necessary pairing with parent objects, etc.</p></div></div><div class="code"><div class="wrapper">      <span class="kd">var</span> <span class="nx">pendingDeferred</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">relationName</span> <span class="k">in</span> <span class="nx">handled</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">pendingDeferred</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">eagerFetch</span><span class="p">(</span><span class="nx">relationName</span><span class="p">,</span> <span class="nx">handled</span><span class="p">[</span><span class="nx">relationName</span><span class="p">],</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
          <span class="nx">isEager</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
          <span class="nx">withRelated</span><span class="o">:</span> <span class="nx">subRelated</span><span class="p">[</span><span class="nx">relationName</span><span class="p">],</span>
          <span class="nx">beforeFn</span><span class="o">:</span> <span class="nx">withRelated</span><span class="p">[</span><span class="nx">relationName</span><span class="p">]</span> <span class="o">||</span> <span class="nx">noop</span>
        <span class="p">})));</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Return a deferred handler for all of the nested object sync
returning the original response when these syncs &amp; pairings are complete.</p></div></div><div class="code"><div class="wrapper">      <span class="k">return</span> <span class="nx">when</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">pendingDeferred</span><span class="p">).</span><span class="nx">yield</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">parentResponse</span><span class="p">);</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Prep the <code>withRelated</code> object, to normalize into an object where each
has a function that is called when running the query.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">prepWithRelated</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">withRelated</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">withRelated</span><span class="p">))</span> <span class="nx">withRelated</span> <span class="o">=</span> <span class="p">[</span><span class="nx">withRelated</span><span class="p">];</span>
      <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">withRelated</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">memo</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">?</span> <span class="nx">memo</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span> <span class="o">=</span> <span class="nx">noop</span> <span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">memo</span><span class="p">,</span> <span class="nx">item</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">memo</span><span class="p">;</span>
      <span class="p">},</span> <span class="p">{});</span>
    <span class="p">},</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Pushes each of the incoming models onto a new <code>related</code> array,
which is used to correcly pair additional nested relations.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">pushModels</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">relationName</span><span class="p">,</span> <span class="nx">handled</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">models</span>      <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">relatedData</span> <span class="o">=</span> <span class="nx">handled</span><span class="p">.</span><span class="nx">relatedData</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">related</span>     <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">related</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">relatedData</span><span class="p">.</span><span class="nx">createModel</span><span class="p">(</span><span class="nx">resp</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">relatedData</span><span class="p">.</span><span class="nx">eagerPair</span><span class="p">(</span><span class="nx">relationName</span><span class="p">,</span> <span class="nx">related</span><span class="p">,</span> <span class="nx">models</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">noop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>

  <span class="nx">EagerBase</span><span class="p">.</span><span class="nx">extend</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">;</span>

  <span class="nx">exports</span><span class="p">.</span><span class="nx">EagerBase</span> <span class="o">=</span> <span class="nx">EagerBase</span><span class="p">;</span>

<span class="p">});</span>

<span class="p">})(</span>
  <span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span> <span class="o">?</span> <span class="nx">define</span> <span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">factory</span><span class="p">)</span> <span class="p">{</span> <span class="nx">factory</span><span class="p">(</span><span class="nx">require</span><span class="p">,</span> <span class="nx">exports</span><span class="p">);</span> <span class="p">}</span>
<span class="p">);</span></div></div></div></div></body></html>