<!DOCTYPE html><html lang="en"><head><title>dialects/sql/sync</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="dialects/sql/sync"><meta name="groc-project-path" content="dialects/sql/sync.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">dialects/sql/sync.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h2 id="sync">Sync</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">_</span>       <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;lodash&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Promise</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../base/promise&#39;</span><span class="p">).</span><span class="nx">Promise</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sync is the dispatcher for any database queries,
taking the "syncing" <code>model</code> or <code>collection</code> being queried, along with
a hash of options that are used in the various query methods.
If the <code>transacting</code> option is set, the query is assumed to be
part of a transaction, and this information is passed along to <code>Knex</code>.</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">Sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">syncing</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">options</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{});</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">query</span>   <span class="o">=</span> <span class="nx">syncing</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">syncing</span> <span class="o">=</span> <span class="nx">syncing</span><span class="p">.</span><span class="nx">resetQuery</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">debug</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">transacting</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">transacting</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">transacting</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Sync</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Prefix all keys of the passed in object with the
current table name</p></div></div><div class="code"><div class="wrapper">  <span class="nx">prefixFields</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tableName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">syncing</span><span class="p">.</span><span class="nx">tableName</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">prefixed</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">fields</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">prefixed</span><span class="p">[</span><span class="nx">tableName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fields</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">prefixed</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Select the first item from the database - only used by models.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">first</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">syncing</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">prefixFields</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">syncing</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)))</span>
    <span class="p">).</span><span class="nx">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">();</span>
  <span class="p">}),</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Runs a <code>select</code> query on the database, adding any necessary relational
constraints, resetting the query when complete. If there are results and
eager loaded relations, those are fetched and returned on the model before
the promise is resolved. Any <code>success</code> handler passed in the
options will be called - used by both models &amp; collections.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">select</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">columns</span><span class="p">,</span> <span class="nx">sync</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">,</span> <span class="nx">relatedData</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">syncing</span><span class="p">.</span><span class="nx">relatedData</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Inject all appropriate select costraints dealing with the relation
into the <code>knex</code> query builder for the current instance.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">relatedData</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">relatedData</span><span class="p">.</span><span class="nx">selectConstraints</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">columns</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">columns</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">columns</span><span class="p">))</span> <span class="nx">columns</span> <span class="o">=</span> <span class="nx">columns</span> <span class="o">?</span> <span class="p">[</span><span class="nx">columns</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">syncing</span><span class="p">,</span> <span class="s1">&#39;tableName&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.*&#39;</span><span class="p">];</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set the query builder on the options, in-case we need to
access in the <code>fetching</code> event handlers.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">options</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Trigger a <code>fetching</code> event on the model, and then select the appropriate columns.</p></div></div><div class="code"><div class="wrapper">    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">syncing</span><span class="p">.</span><span class="nx">triggerThen</span><span class="p">(</span><span class="s1">&#39;fetching&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">syncing</span><span class="p">,</span> <span class="nx">columns</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">columns</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}),</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Issues an <code>insert</code> command on the query - only used by models.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">insert</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">syncing</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">syncing</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span>
      <span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">syncing</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span> <span class="nx">syncing</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)),</span> <span class="nx">syncing</span><span class="p">.</span><span class="nx">idAttribute</span><span class="p">);</span>
  <span class="p">}),</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Issues an <code>update</code> command on the query - only used by models.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">update</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">syncing</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">syncing</span><span class="p">,</span> <span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">syncing</span><span class="p">.</span><span class="nx">id</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">query</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">syncing</span><span class="p">.</span><span class="nx">idAttribute</span><span class="p">,</span> <span class="nx">syncing</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">wheres</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;A model cannot be updated without a &quot;where&quot; clause or an idAttribute.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">query</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">syncing</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span> <span class="nx">attrs</span><span class="p">)));</span>
  <span class="p">}),</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Issues a <code>delete</code> command on the query.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">del</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">,</span> <span class="nx">syncing</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">syncing</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">syncing</span><span class="p">.</span><span class="nx">id</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">query</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">syncing</span><span class="p">.</span><span class="nx">idAttribute</span><span class="p">,</span> <span class="nx">syncing</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">wheres</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;A model cannot be destroyed without a &quot;where&quot; clause or an idAttribute.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">del</span><span class="p">();</span>
  <span class="p">})</span>

<span class="p">});</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">Sync</span> <span class="o">=</span> <span class="nx">Sync</span><span class="p">;</span></div></div></div></div></body></html>