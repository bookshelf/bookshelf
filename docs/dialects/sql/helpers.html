<!DOCTYPE html><html lang="en"><head><title>dialects/sql/helpers</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="dialects/sql/helpers"><meta name="groc-project-path" content="dialects/sql/helpers.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">dialects/sql/helpers.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h2 id="helpers">Helpers</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;lodash&#39;</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">Helpers</span> <span class="o">=</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sets the constraints necessary during a <code>model.save</code> call.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">saveConstraints</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">relatedData</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">relatedData</span> <span class="o">&amp;&amp;</span> <span class="nx">relatedData</span><span class="p">.</span><span class="nx">type</span> <span class="o">&amp;&amp;</span> <span class="nx">relatedData</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;belongsToMany&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span><span class="p">[</span><span class="nx">relatedData</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span><span class="s1">&#39;foreignKey&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">relatedData</span><span class="p">.</span><span class="nx">parentFk</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">relatedData</span><span class="p">.</span><span class="nx">isMorph</span><span class="p">())</span> <span class="nx">data</span><span class="p">[</span><span class="nx">relatedData</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span><span class="s1">&#39;morphKey&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">relatedData</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span><span class="s1">&#39;morphValue&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Finds the specific <code>morphTo</code> table we should be working with, or throws
an error if none is matched.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">morphCandidate</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">candidates</span><span class="p">,</span> <span class="nx">foreignTable</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">Target</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">candidates</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Candidate</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="nx">Candidate</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="s1">&#39;tableName&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">foreignTable</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Target</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;The target polymorphic model was not found&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">Target</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If there are no arguments, return the current object's
query builder (or create and return a new one). If there are arguments,
call the query builder with the first argument, applying the rest.
If the first argument is an object, assume the keys are query builder
methods, and the values are the arguments for the query.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">query</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">obj</span><span class="p">.</span><span class="nx">_knex</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_knex</span> <span class="o">||</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_builder</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="s1">&#39;tableName&#39;</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_knex</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">method</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">method</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">_knex</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_knex</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">method</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">method</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="o">?</span>  <span class="nx">method</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="nx">method</span><span class="p">[</span><span class="nx">key</span><span class="p">]];</span>
        <span class="nx">obj</span><span class="p">.</span><span class="nx">_knex</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">_knex</span><span class="p">,</span> <span class="nx">target</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">obj</span><span class="p">.</span><span class="nx">_knex</span><span class="p">[</span><span class="nx">method</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">_knex</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
  <span class="p">}</span>

<span class="p">};</span></div></div></div></div></body></html>