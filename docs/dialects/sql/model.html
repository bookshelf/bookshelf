<!DOCTYPE html><html lang="en"><head><title>dialects/sql/model</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="dialects/sql/model"><meta name="groc-project-path" content="dialects/sql/model.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">dialects/sql/model.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h2 id="model">Model</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">_</span>             <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;lodash&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Sync</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./sync&#39;</span><span class="p">).</span><span class="nx">Sync</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">Helpers</span>       <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./helpers&#39;</span><span class="p">).</span><span class="nx">Helpers</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">EagerRelation</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./eager&#39;</span><span class="p">).</span><span class="nx">EagerRelation</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">ModelBase</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../base/model&#39;</span><span class="p">).</span><span class="nx">ModelBase</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">Promise</span>   <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../base/promise&#39;</span><span class="p">).</span><span class="nx">Promise</span><span class="p">;</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">Model</span> <span class="o">=</span> <span class="nx">ModelBase</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The <code>hasOne</code> relation specifies that this table has exactly one of another type of object,
specified by a foreign key in the other table. The foreign key is assumed to be the singular of this
object's <code>tableName</code> with an <code>_id</code> suffix, but a custom <code>foreignKey</code> attribute may also be specified.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">hasOne</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">foreignKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relation</span><span class="p">(</span><span class="s1">&#39;hasOne&#39;</span><span class="p">,</span> <span class="nx">Target</span><span class="p">,</span> <span class="p">{</span><span class="nx">foreignKey</span><span class="o">:</span> <span class="nx">foreignKey</span><span class="p">}).</span><span class="nx">init</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The <code>hasMany</code> relation specifies that this object has one or more rows in another table which
match on this object's primary key. The foreign key is assumed to be the singular of this object's
<code>tableName</code> with an <code>_id</code> suffix, but a custom <code>foreignKey</code> attribute may also be specified.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">hasMany</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">foreignKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relation</span><span class="p">(</span><span class="s1">&#39;hasMany&#39;</span><span class="p">,</span> <span class="nx">Target</span><span class="p">,</span> <span class="p">{</span><span class="nx">foreignKey</span><span class="o">:</span> <span class="nx">foreignKey</span><span class="p">}).</span><span class="nx">init</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A reverse <code>hasOne</code> relation, the <code>belongsTo</code>, where the specified key in this table
matches the primary <code>idAttribute</code> of another table.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">belongsTo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">foreignKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relation</span><span class="p">(</span><span class="s1">&#39;belongsTo&#39;</span><span class="p">,</span> <span class="nx">Target</span><span class="p">,</span> <span class="p">{</span><span class="nx">foreignKey</span><span class="o">:</span> <span class="nx">foreignKey</span><span class="p">}).</span><span class="nx">init</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A <code>belongsToMany</code> relation is when there are many-to-many relation
between two models, with a joining table.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">belongsToMany</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">joinTableName</span><span class="p">,</span> <span class="nx">foreignKey</span><span class="p">,</span> <span class="nx">otherKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relation</span><span class="p">(</span><span class="s1">&#39;belongsToMany&#39;</span><span class="p">,</span> <span class="nx">Target</span><span class="p">,</span> <span class="p">{</span>
      <span class="nx">joinTableName</span><span class="o">:</span> <span class="nx">joinTableName</span><span class="p">,</span> <span class="nx">foreignKey</span><span class="o">:</span> <span class="nx">foreignKey</span><span class="p">,</span> <span class="nx">otherKey</span><span class="o">:</span> <span class="nx">otherKey</span>
    <span class="p">}).</span><span class="nx">init</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A <code>morphOne</code> relation is a one-to-one polymorphic association from this model
to another model.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">morphOne</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">morphValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_morphOneOrMany</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">morphValue</span><span class="p">,</span> <span class="s1">&#39;morphOne&#39;</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>A <code>morphMany</code> relation is a polymorphic many-to-one relation from this model
to many another models.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">morphMany</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">morphValue</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_morphOneOrMany</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">morphValue</span><span class="p">,</span> <span class="s1">&#39;morphMany&#39;</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Defines the opposite end of a <code>morphOne</code> or <code>morphMany</code> relationship, where
the alternate end of the polymorphic model is defined.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">morphTo</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">morphName</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">morphName</span><span class="p">))</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;The `morphTo` name must be specified.&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relation</span><span class="p">(</span><span class="s1">&#39;morphTo&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="nx">morphName</span><span class="o">:</span> <span class="nx">morphName</span><span class="p">,</span> <span class="nx">candidates</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">rest</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)}).</span><span class="nx">init</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Used to define passthrough relationships - <code>hasOne</code>, <code>hasMany</code>,
<code>belongsTo</code> or <code>belongsToMany</code>, "through" a <code>Interim</code> model or collection.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">through</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Interim</span><span class="p">,</span> <span class="nx">foreignKey</span><span class="p">,</span> <span class="nx">otherKey</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedData</span><span class="p">.</span><span class="nx">through</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">Interim</span><span class="p">,</span> <span class="p">{</span><span class="nx">throughForeignKey</span><span class="o">:</span> <span class="nx">foreignKey</span><span class="p">,</span> <span class="nx">otherKey</span><span class="o">:</span> <span class="nx">otherKey</span><span class="p">});</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Fetch a model based on the currently set attributes,
returning a model to the callback, along with any options.
Returns a deferred promise through the <code>Bookshelf.Sync</code>.
If <code>{require: true}</code> is set as an option, the fetch is considered
a failure if the model comes up blank.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">fetch</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">?</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">:</span> <span class="p">{};</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Run the <code>first</code> call on the <code>sync</code> object to fetch a single model.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">sync</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">first</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Jump the rest of the chain if the response doesn't exist...</p></div></div><div class="code"><div class="wrapper">      <span class="p">.</span><span class="nx">tap</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">response</span> <span class="o">||</span> <span class="nx">response</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">require</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;EmptyResponse&#39;</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">})</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Now, load all of the data into the model as necessary.</p></div></div><div class="code"><div class="wrapper">      <span class="p">.</span><span class="nx">tap</span><span class="p">(</span><span class="nx">handleResponse</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the "withRelated" is specified, we also need to eager load all of the
data on the model, as a side-effect, before we ultimately jump into the
next step of the model. Since the <code>columns</code> are only relevant to the current
level, ensure those are omitted from the options.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">withRelated</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">sync</span> <span class="o">=</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">tap</span><span class="p">(</span><span class="nx">handleEager</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">tap</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">triggerThen</span><span class="p">(</span><span class="s1">&#39;fetched&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">yield</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">caught</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="k">return</span> <span class="nx">err</span><span class="p">;</span>
      <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="p">});</span>

  <span class="p">}),</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Eager loads relationships onto an already populated <code>Model</code> instance.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">load</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">relations</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">({</span><span class="nx">shallow</span><span class="o">:</span> <span class="kc">true</span><span class="p">})];</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">handleEager</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">options</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">shallow</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">withRelated</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">relations</span><span class="p">)</span> <span class="o">?</span> <span class="nx">relations</span> <span class="o">:</span> <span class="p">[</span><span class="nx">relations</span><span class="p">]</span>
      <span class="p">}))).</span><span class="nx">yield</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}),</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Sets and saves the hash of model attributes, triggering
a "creating" or "updating" event on the model, as well as a "saving" event,
to bind listeners for any necessary validation, logging, etc.
If an error is thrown during these events, the model will not be saved.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">save</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">method</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">attrs</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Handle both <code>"key", value</code> and <code>{key: value}</code> -style arguments.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">key</span> <span class="o">===</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">attrs</span> <span class="o">=</span> <span class="nx">key</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="p">(</span><span class="nx">attrs</span> <span class="o">=</span> <span class="p">{})[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">?</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">:</span> <span class="p">{};</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">isNew</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">isNew</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the model has timestamp columns,
set them as attributes on the model, even
if the "patch" option is specified.</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasTimestamps</span><span class="p">)</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">attrs</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">(</span><span class="nx">options</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Determine whether the model is new, based on whether the model has an <code>idAttribute</code> or not.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">||</span> <span class="p">(</span><span class="nx">isNew</span> <span class="o">?</span> <span class="s1">&#39;insert&#39;</span> <span class="o">:</span> <span class="s1">&#39;update&#39;</span><span class="p">)).</span><span class="nx">toLowerCase</span><span class="p">();</span>
      <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">method</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">vals</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the object is being created, we merge any defaults here
rather than during object creation.</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;insert&#39;</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">defaults</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">defaults</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;defaults&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">defaults</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">vals</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">defaults</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">vals</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set the attributes on the model.</p></div></div><div class="code"><div class="wrapper">      <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">vals</span><span class="p">,</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If there are any save constraints, set them on the model.</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">relatedData</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedData</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;morphTo&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Helpers</span><span class="p">.</span><span class="nx">saveConstraints</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedData</span><span class="p">);</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Gives access to the <code>query</code> object in the <code>options</code>, in case we need it
in any event handlers.</p></div></div><div class="code"><div class="wrapper">      <span class="kd">var</span> <span class="nx">sync</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>

      <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">triggerThen</span><span class="p">((</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;insert&#39;</span> <span class="o">?</span> <span class="s1">&#39;creating&#39;</span> <span class="o">:</span> <span class="s1">&#39;updating&#39;</span><span class="p">),</span> <span class="k">this</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">),</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">triggerThen</span><span class="p">(</span><span class="s1">&#39;saving&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
      <span class="p">])</span>
      <span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">sync</span><span class="p">[</span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span><span class="p">](</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;update&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">patch</span> <span class="o">?</span> <span class="nx">attrs</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">);</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>After a successful database save, the id is updated if the model was created</p></div></div><div class="code"><div class="wrapper">        <span class="k">if</span> <span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;insert&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">idAttribute</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">resp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;update&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">resp</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;No rows were affected in the update, did you mean to pass the {method: &quot;insert&quot;} option?&#39;</span><span class="p">);</span>
        <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>In case we need to reference the <code>previousAttributes</code> for the this
in the following event handlers.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">options</span><span class="p">.</span><span class="nx">previousAttributes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_previousAttributes</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">_reset</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">triggerThen</span><span class="p">((</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;insert&#39;</span> <span class="o">?</span> <span class="s1">&#39;created&#39;</span> <span class="o">:</span> <span class="s1">&#39;updated&#39;</span><span class="p">),</span> <span class="k">this</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">),</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">triggerThen</span><span class="p">(</span><span class="s1">&#39;saved&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
        <span class="p">]);</span>

      <span class="p">});</span>

    <span class="p">}).</span><span class="nx">yield</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}),</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Reset the query builder, called internally
each time a query is run.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">resetQuery</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_knex</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Returns an instance of the query builder.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">query</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Helpers</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">toArray</span><span class="p">(</span><span class="nx">arguments</span><span class="p">));</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Creates and returns a new <code>Sync</code> instance.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">sync</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Sync</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
  <span class="p">},</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Helper for setting up the <code>morphOne</code> or <code>morphMany</code> relations.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">_morphOneOrMany</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">morphName</span><span class="p">,</span> <span class="nx">morphValue</span><span class="p">,</span> <span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">morphName</span> <span class="o">||</span> <span class="o">!</span><span class="nx">Target</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;The polymorphic `name` and `Target` are required.&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_relation</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">Target</span><span class="p">,</span> <span class="p">{</span><span class="nx">morphName</span><span class="o">:</span> <span class="nx">morphName</span><span class="p">,</span> <span class="nx">morphValue</span><span class="o">:</span> <span class="nx">morphValue</span><span class="p">}).</span><span class="nx">init</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Handles the response data for the model, returning from the model's fetch call.
Todo: {silent: true, parse: true}, for parity with collection#set
need to check on Backbone's status there, ticket #2636</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">handleResponse</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">relatedData</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">relatedData</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span> <span class="kc">true</span><span class="p">}).</span><span class="nx">_reset</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">relatedData</span> <span class="o">&amp;&amp;</span> <span class="nx">relatedData</span><span class="p">.</span><span class="nx">isJoined</span><span class="p">())</span> <span class="p">{</span>
    <span class="nx">relatedData</span><span class="p">.</span><span class="nx">parsePivot</span><span class="p">([</span><span class="k">this</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Handle the related data loading on the model.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">handleEager</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">EagerRelation</span><span class="p">([</span><span class="k">this</span><span class="p">],</span> <span class="nx">response</span><span class="p">,</span> <span class="k">this</span><span class="p">).</span><span class="nx">fetch</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span></div></div></div></div></body></html>