<!DOCTYPE html>

<html>
<head>
  <title>model.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="bookshelf.html">
                bookshelf.js
              </a>
            
              
              <a class="source" href="collection.html">
                collection.js
              </a>
            
              
              <a class="source" href="eager.html">
                eager.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="helpers.html">
                helpers.js
              </a>
            
              
              <a class="source" href="model.html">
                model.js
              </a>
            
              
              <a class="source" href="relation.html">
                relation.js
              </a>
            
              
              <a class="source" href="sync.html">
                sync.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>model.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="keyword">function</span>(define) { <span class="string">"use strict"</span>;

define(<span class="keyword">function</span>(require, exports, module) {

  <span class="keyword">var</span> _             = require(<span class="string">'./ext/underscore'</span>)._;
  <span class="keyword">var</span> Backbone      = require(<span class="string">'./ext/backbone'</span>).Backbone;
  <span class="keyword">var</span> when          = require(<span class="string">'./ext/when'</span>).when;

  <span class="keyword">var</span> Events        = require(<span class="string">'./events'</span>).Events;
  <span class="keyword">var</span> Helpers       = require(<span class="string">'./helpers'</span>).Helpers;
  <span class="keyword">var</span> Eager         = require(<span class="string">'./eager'</span>).Eager;
  <span class="keyword">var</span> Sync          = require(<span class="string">'./sync'</span>).Sync;
  <span class="keyword">var</span> Relation      = require(<span class="string">'./relation'</span>).Relation;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h2>Bookshelf.Model</h2>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>A Bookshelf Model represents an individual row in the database table --
It has a similar implementation to the <code>Backbone.Model</code>
constructor, except that defaults are not set until the
object is persisted, and the collection property is not used.</p>
<p>A unique <code>cid</code> property is also added to each created model, similar to
<code>Backbone</code> models, and is useful checking the identity of two models.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> Model = <span class="keyword">function</span>(attributes, options) {
    <span class="keyword">var</span> attrs = attributes || {};
    options || (options = {});
    <span class="keyword">this</span>.attributes = Object.create(<span class="literal">null</span>);
    <span class="keyword">this</span>._reset();
    <span class="keyword">this</span>.relations = {};
    <span class="keyword">this</span>.cid  = _.uniqueId(<span class="string">'c'</span>);
    <span class="keyword">if</span> (options) {
      _.extend(<span class="keyword">this</span>, _.pick(options, modelProps));
      <span class="keyword">if</span> (options.parse) attrs = <span class="keyword">this</span>.parse(attrs, options) || {};
    }
    <span class="keyword">this</span>.set(attrs, options);
    <span class="keyword">this</span>.initialize.apply(<span class="keyword">this</span>, arguments);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>A list of properties that are omitted from the <code>Backbone.Model.prototype</code>, since we&#39;re not
handling validations, or tracking changes in the same fashion as <code>Backbone</code>, we can drop these
specific methods.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> modelOmitted = [<span class="string">'changedAttributes'</span>, <span class="string">'isValid'</span>, <span class="string">'validationError'</span>, <span class="string">'_validate'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>List of attributes attached directly from the <code>options</code> passed to the constructor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">var</span> modelProps = [<span class="string">'tableName'</span>, <span class="string">'hasTimestamps'</span>];

  _.extend(Model.prototype, _.omit(Backbone.Model.prototype, modelOmitted), Events, {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>The <code>hasOne</code> relation specifies that this table has exactly one of another type of object,
specified by a foreign key in the other table. The foreign key is assumed to be the singular of this
object&#39;s <code>tableName</code> with an <code>_id</code> suffix, but a custom <code>foreignKey</code> attribute may also be specified.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    hasOne: <span class="keyword">function</span>(Target, foreignKey) {
      <span class="keyword">return</span> <span class="keyword">new</span> Relation(<span class="string">'hasOne'</span>, Target, {foreignKey: foreignKey}).init(<span class="keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The <code>hasMany</code> relation specifies that this object has one or more rows in another table which
match on this object&#39;s primary key. The foreign key is assumed to be the singular of this object&#39;s
<code>tableName</code> with an <code>_id</code> suffix, but a custom <code>foreignKey</code> attribute may also be specified.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    hasMany: <span class="keyword">function</span>(Target, foreignKey) {
      <span class="keyword">return</span> <span class="keyword">new</span> Relation(<span class="string">'hasMany'</span>, Target, {foreignKey: foreignKey}).init(<span class="keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>A reverse <code>hasOne</code> relation, the <code>belongsTo</code>, where the specified key in this table
matches the primary <code>idAttribute</code> of another table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    belongsTo: <span class="keyword">function</span>(Target, otherKey) {
      <span class="keyword">return</span> <span class="keyword">new</span> Relation(<span class="string">'belongsTo'</span>, Target, {otherKey: otherKey}).init(<span class="keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>A <code>belongsToMany</code> relation is when there are many-to-many relation
between two models, with a joining table.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    belongsToMany: <span class="keyword">function</span>(Target, joinTableName, foreignKey, otherKey) {
      <span class="keyword">return</span> <span class="keyword">new</span> Relation(<span class="string">'belongsToMany'</span>, Target, {
        joinTableName: joinTableName, foreignKey: foreignKey, otherKey: otherKey
      }).init(<span class="keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>A <code>morphOne</code> relation is a one-to-one polymorphic association from this model
to another model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    morphOne: <span class="keyword">function</span>(Target, name, morphValue) {
      <span class="keyword">return</span> <span class="keyword">this</span>._morphOneOrMany(Target, name, morphValue, <span class="string">'morphOne'</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>A <code>morphMany</code> relation is a polymorphic many-to-one relation from this model
to many another models.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    morphMany: <span class="keyword">function</span>(Target, name, morphValue) {
      <span class="keyword">return</span> <span class="keyword">this</span>._morphOneOrMany(Target, name, morphValue, <span class="string">'morphMany'</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Defines the opposite end of a <code>morphOne</code> or <code>morphMany</code> relationship, where
the alternate end of the polymorphic model is defined.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    morphTo: <span class="keyword">function</span>(morphName) {
      <span class="keyword">if</span> (!_.isString(morphName)) <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'The `morphTo` name must be specified.'</span>);
      <span class="keyword">return</span> <span class="keyword">new</span> Relation(<span class="string">'morphTo'</span>, <span class="literal">null</span>, {morphName: morphName, candidates: _.rest(arguments)}).init(<span class="keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Used to define passthrough relationships - <code>hasOne</code>, <code>hasMany</code>,
<code>belongsTo</code> or <code>belongsToMany</code>, &quot;through&quot; a <code>Interim</code> model or collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    through: <span class="keyword">function</span>(Interim, foreignKey, otherKey) {
      <span class="keyword">return</span> <span class="keyword">this</span>.relatedData.through(<span class="keyword">this</span>, Interim, {throughForeignKey: foreignKey, otherKey: otherKey});
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Fetch a model based on the currently set attributes,
returning a model to the callback, along with any options.
Returns a deferred promise through the <code>Bookshelf.Sync</code>.
If <code>{require: true}</code> is set as an option, the fetch is considered
a failure if the model comes up blank.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    fetch: <span class="keyword">function</span>(options) {
      options || (options = {});
      <span class="keyword">var</span> model = <span class="keyword">this</span>, relatedData = <span class="keyword">this</span>.relatedData;
      <span class="keyword">return</span> <span class="keyword">this</span>.sync(options)
        .first()
        .then(<span class="keyword">function</span>(response) {
          <span class="keyword">if</span> (response &amp;&amp; response.length &gt; <span class="number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Todo: {silent: true, parse: true}, for parity with collection#set
need to check on Backbone&#39;s status there, ticket #2636</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            model.set(model.parse(response[<span class="number">0</span>]), {silent: <span class="literal">true</span>})._reset();

            <span class="keyword">if</span> (relatedData &amp;&amp; relatedData.isJoined()) {
              relatedData.parsePivot([model]);
            }

            <span class="keyword">if</span> (!options.withRelated) <span class="keyword">return</span> response;
            <span class="keyword">return</span> <span class="keyword">new</span> Eager([model], response, model)
              .fetch(options)
              .then(<span class="keyword">function</span>() { <span class="keyword">return</span> response; });
          }
          <span class="keyword">if</span> (options.require) <span class="keyword">return</span> when.reject(<span class="keyword">new</span> Error(<span class="string">'EmptyResponse'</span>));
        })
        .then(<span class="keyword">function</span>(response) {
          <span class="keyword">if</span> (response &amp;&amp; response.length &gt; <span class="number">0</span>) {
            <span class="keyword">return</span> model.triggerThen(<span class="string">'fetched'</span>, model, response, options).then(<span class="keyword">function</span>() {
              <span class="keyword">return</span> model;
            });
          }
          <span class="keyword">return</span> <span class="literal">null</span>;
        });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Eager loads relationships onto an already populated <code>Model</code> instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    load: <span class="keyword">function</span>(relations, options) {
      <span class="keyword">var</span> model = <span class="keyword">this</span>;
      _.isArray(relations) || (relations = [relations]);
      options = _.extend({}, options, {shallow: <span class="literal">true</span>, withRelated: relations});
      <span class="keyword">return</span> <span class="keyword">new</span> Eager([<span class="keyword">this</span>], [<span class="keyword">this</span>.toJSON(options)], <span class="keyword">this</span>)
        .fetch(options)
        .then(<span class="keyword">function</span>() { <span class="keyword">return</span> model; });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Similar to the standard <code>Backbone</code> set method, but without individual
change events, and adding different meaning to <code>changed</code> and <code>previousAttributes</code>
defined as the last &quot;sync&quot;&#39;ed state of the model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    set: <span class="keyword">function</span>(key, val, options) {
      <span class="keyword">if</span> (key == <span class="literal">null</span>) <span class="keyword">return</span> <span class="keyword">this</span>;
      <span class="keyword">var</span> attrs, changing;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Handle both <code>&quot;key&quot;, value</code> and <code>{key: value}</code> -style arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (<span class="keyword">typeof</span> key === <span class="string">'object'</span>) {
        attrs = key;
        options = val;
      } <span class="keyword">else</span> {
        (attrs = {})[key] = val;
      }
      options || (options = {});</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Extract attributes and options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> hasChanged = <span class="literal">false</span>;
      <span class="keyword">var</span> unset   = options.unset;
      <span class="keyword">var</span> current = <span class="keyword">this</span>.attributes;
      <span class="keyword">var</span> prev    = <span class="keyword">this</span>._previousAttributes;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Check for changes of <code>id</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (<span class="keyword">this</span>.idAttribute <span class="keyword">in</span> attrs) <span class="keyword">this</span>.id = attrs[<span class="keyword">this</span>.idAttribute];</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>For each <code>set</code> attribute, update or delete the current value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">for</span> (<span class="keyword">var</span> attr <span class="keyword">in</span> attrs) {
        val = attrs[attr];
        <span class="keyword">if</span> (!_.isEqual(prev[attr], val)) {
          <span class="keyword">this</span>.changed[attr] = val;
          <span class="keyword">if</span> (!_.isEqual(current[attr], val)) hasChanged = <span class="literal">true</span>;
        } <span class="keyword">else</span> {
          <span class="keyword">delete</span> <span class="keyword">this</span>.changed[attr];
        }
        unset ? <span class="keyword">delete</span> current[attr] : current[attr] = val;
      }

      <span class="keyword">if</span> (hasChanged &amp;&amp; !options.silent) <span class="keyword">this</span>.trigger(<span class="string">'change'</span>, <span class="keyword">this</span>, options);
      <span class="keyword">return</span> <span class="keyword">this</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Sets and saves the hash of model attributes, triggering
a &quot;creating&quot; or &quot;updating&quot; event on the model, as well as a &quot;saving&quot; event,
to bind listeners for any necessary validation, logging, etc.
If an error is thrown during these events, the model will not be saved.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    save: <span class="keyword">function</span>(key, val, options) {
      <span class="keyword">var</span> attrs;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Handle both <code>&quot;key&quot;, value</code> and <code>{key: value}</code> -style arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (key == <span class="literal">null</span> || <span class="keyword">typeof</span> key === <span class="string">"object"</span>) {
        attrs = key || {};
        options = val || {};
      } <span class="keyword">else</span> {
        options || (options = {});
        (attrs = {})[key] = val;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>If the model has timestamp columns,
set them as attributes on the model, even
if the &quot;patch&quot; option is specified.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (<span class="keyword">this</span>.hasTimestamps) _.extend(attrs, <span class="keyword">this</span>.timestamp(options));</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Determine whether the model is new, based on whether the model has an <code>idAttribute</code> or not.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> method = options.method || (options.method = <span class="keyword">this</span>.isNew(options) ? <span class="string">'insert'</span> : <span class="string">'update'</span>);
      <span class="keyword">var</span> vals = attrs;</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>If the object is being created, we merge any defaults here
rather than during object creation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (method === <span class="string">'insert'</span> || options.defaults) {
        <span class="keyword">var</span> defaults = _.result(<span class="keyword">this</span>, <span class="string">'defaults'</span>);
        <span class="keyword">if</span> (defaults) {
          vals = _.extend({}, defaults, <span class="keyword">this</span>.attributes, vals);
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Set the attributes on the model, and maintain a reference to use below.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">var</span> model = <span class="keyword">this</span>.set(vals, {silent: <span class="literal">true</span>});</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>If there are any save constraints, set them on the model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="keyword">if</span> (<span class="keyword">this</span>.relatedData) Helpers.saveConstraints(<span class="keyword">this</span>, <span class="keyword">this</span>.relatedData);

      <span class="keyword">var</span> sync = <span class="keyword">this</span>.sync(options);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Gives access to the <code>query</code> object in the <code>options</code>, in case we need it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      options.query = sync.query;

      <span class="keyword">return</span> when.all([
        model.triggerThen((method === <span class="string">'insert'</span> ? <span class="string">'creating'</span> : <span class="string">'updating'</span>), model, attrs, options),
        model.triggerThen(<span class="string">'saving'</span>, model, attrs, options)
      ])
      .then(<span class="keyword">function</span>() { <span class="keyword">return</span> sync[options.method](attrs, options); })
      .then(<span class="keyword">function</span>(resp) {</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>After a successful database save, the id is updated if the model was created</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (method === <span class="string">'insert'</span> &amp;&amp; resp) {
          model.attributes[model.idAttribute] = model[model.idAttribute] = resp[<span class="number">0</span>];
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>In case we need to reference the <code>previousAttributes</code> for the model
in the following event handlers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        options.previousAttributes = model._previousAttributes;

        model._reset();

        <span class="keyword">return</span> when.all([
          model.triggerThen((method === <span class="string">'insert'</span> ? <span class="string">'created'</span> : <span class="string">'updated'</span>), model, resp, options),
          model.triggerThen(<span class="string">'saved'</span>, model, resp, options)
        ]);

      }).then(<span class="keyword">function</span>() {
        <span class="keyword">return</span> model;
      });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Destroy a model, calling a &quot;delete&quot; based on its <code>idAttribute</code>.
A &quot;destroying&quot; and &quot;destroyed&quot; are triggered on the model before
and after the model is destroyed, respectively. If an error is thrown
during the &quot;destroying&quot; event, the model will not be destroyed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    destroy: <span class="keyword">function</span>(options) {
      options || (options = {});
      <span class="keyword">var</span> model = <span class="keyword">this</span>;
      <span class="keyword">return</span> model.triggerThen(<span class="string">'destroying'</span>, model, options)
      .then(<span class="keyword">function</span>() { <span class="keyword">return</span> model.sync(options).del(options); })
      .then(<span class="keyword">function</span>(resp) {
        model.clear();
        <span class="keyword">return</span> model.triggerThen(<span class="string">'destroyed'</span>, model, resp, options).then(<span class="keyword">function</span>() {
          <span class="keyword">return</span> model._reset();
        });
      });
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p><strong>format</strong> converts a model into the values that should be saved into
the database table. The default implementation is just to pass the response along.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    format: <span class="keyword">function</span>(attrs, options) {
      <span class="keyword">return</span> attrs;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Returns an object containing a shallow copy of the model attributes,
along with the <code>toJSON</code> value of any relations,
unless <code>{shallow: true}</code> is passed in the <code>options</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    toJSON: <span class="keyword">function</span>(options) {
      <span class="keyword">var</span> attrs = _.extend({}, <span class="keyword">this</span>.attributes);
      <span class="keyword">if</span> (options &amp;&amp; options.shallow) <span class="keyword">return</span> attrs;
      <span class="keyword">var</span> relations = <span class="keyword">this</span>.relations;
      <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> relations) {
        <span class="keyword">var</span> relation = relations[key];
        attrs[key] = relation.toJSON ? relation.toJSON() : relation;
      }
      <span class="keyword">if</span> (<span class="keyword">this</span>.pivot) {
        <span class="keyword">var</span> pivot = <span class="keyword">this</span>.pivot.attributes;
        <span class="keyword">for</span> (key <span class="keyword">in</span> pivot) {
          attrs[<span class="string">'_pivot_'</span> + key] = pivot[key];
        }
      }
      <span class="keyword">return</span> attrs;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Sets the timestamps before saving the model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    timestamp: <span class="keyword">function</span>(options) {
      <span class="keyword">var</span> d = <span class="keyword">new</span> Date();
      <span class="keyword">var</span> keys = (_.isArray(<span class="keyword">this</span>.hasTimestamps) ? <span class="keyword">this</span>.hasTimestamps : [<span class="string">'created_at'</span>, <span class="string">'updated_at'</span>]);
      <span class="keyword">var</span> vals = {};
      vals[keys[<span class="number">1</span>]] = d;
      <span class="keyword">if</span> (<span class="keyword">this</span>.isNew(options) &amp;&amp; (!options || options.method !== <span class="string">'update'</span>)) vals[keys[<span class="number">0</span>]] = d;
      <span class="keyword">return</span> vals;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Create a new model with identical attributes to this one,
including any relations on the current model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    clone: <span class="keyword">function</span>() {
      <span class="keyword">var</span> model = <span class="keyword">new</span> <span class="keyword">this</span>.constructor(<span class="keyword">this</span>.attributes);
      <span class="keyword">var</span> relations = <span class="keyword">this</span>.relations;
      <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> relations) {
        model.relations[key] = relations[key].clone();
      }
      model._previousAttributes = _.clone(<span class="keyword">this</span>._previousAttributes);
      model.changed = _.clone(<span class="keyword">this</span>.changed);
      <span class="keyword">return</span> model;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Returns the related item, or creates a new
related item by creating a new model or collection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    related: <span class="keyword">function</span>(name) {
      <span class="keyword">return</span> <span class="keyword">this</span>.relations[name] || (<span class="keyword">this</span>[name] ? <span class="keyword">this</span>.relations[name] = <span class="keyword">this</span>[name]() : <span class="keyword">void</span> <span class="number">0</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Reset the query builder, called internally
each time a query is run.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    resetQuery: <span class="keyword">function</span>() {
      <span class="keyword">delete</span> <span class="keyword">this</span>._knex;
      <span class="keyword">return</span> <span class="keyword">this</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Returns an instance of the query builder.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    query: <span class="keyword">function</span>() {
      <span class="keyword">return</span> Helpers.query(<span class="keyword">this</span>, _.toArray(arguments));
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Creates and returns a new <code>Bookshelf.Sync</code> instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sync: <span class="keyword">function</span>(options) {
      <span class="keyword">return</span> <span class="keyword">new</span> Sync(<span class="keyword">this</span>, options);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Helper for setting up the <code>morphOne</code> or <code>morphMany</code> relations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _morphOneOrMany: <span class="keyword">function</span>(Target, morphName, morphValue, type) {
      <span class="keyword">if</span> (!morphName || !Target) <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'The polymorphic `name` and `Target` are required.'</span>);
      <span class="keyword">return</span> <span class="keyword">new</span> Relation(type, Target, {morphName: morphName, morphValue: morphValue}).init(<span class="keyword">this</span>);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Called after a <code>sync</code> action (save, fetch, delete) -
resets the <code>_previousAttributes</code> and <code>changed</code> hash for the model.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    _reset: <span class="keyword">function</span>() {
      <span class="keyword">this</span>._previousAttributes = _.extend(Object.create(<span class="literal">null</span>), <span class="keyword">this</span>.attributes);
      <span class="keyword">this</span>.changed = Object.create(<span class="literal">null</span>);
      <span class="keyword">return</span> <span class="keyword">this</span>;
    }

  });

  exports.Model = Model;

});

})(
  <span class="keyword">typeof</span> define === <span class="string">'function'</span> &amp;&amp; define.amd ? define : <span class="function"><span class="keyword">function</span> <span class="params">(factory)</span> {</span> factory(require, exports, module); }
);</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
